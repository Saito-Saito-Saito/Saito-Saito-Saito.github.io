<html lang="ja">
<head>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-166967736-1"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-166967736-1');
    </script>
    
    <title>Pythonプログラミングでリバーシを作る 5-2</title>

    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta property="og:url" content="https://Saito-Saito-Saito.github.io/chess/stage5/section2">
    <meta property="og:title" content="Pythonプログラミングでリバーシを作る 5-2">
    <meta property="og:description" content="Pythonプログラミングによって、ターミナル上で実行できるリバーシのゲームで、石を裏返す機能を実装していきます。">
    <meta name="description" content="Pythonプログラミングによって、ターミナル上で実行できるリバーシのゲームで、石を裏返す機能を実装していきます。">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="twitter:card" content="summary_large_image">
    <meta property="og:image" content="https://Saito-Saito-Saito.github.io/unagi-study.JPG">
    <meta name="google-site-verification" content="d3cz5KLnsS_25m1Shebvuyb3C4FfyoFNlPXdQ3z_oXg" />

    <link rel="icon" href="https://Saito-Saito-Saito.github.io/icon.png">
    <link rel="stylesheet" href="https://Saito-Saito-Saito.github.io/reversi/stylesheet.css">
</head>
<body>
    <header>
        <img src="https://Saito-Saito-Saito.github.io/unagi-top.png" alt="" width="90px">
        <div id="title">
            <h1>Pythonプログラミングで</h1>
            <h1>リバーシを作る</h1>
        </div>
    </header>

    <div id="menu-bar">
        <div id="short-menu">
                    <input type="checkbox" id="acd-check">
                    <table>
                        <tr><td><a href="https://Saito-Saito-Saito.github.io/reversi">HOME</a></td><td><label for="acd-check">STAGES</label></td><td><a href="https://Saito-Saito-Saito.github.io/reversi/code">CODE</a></td></tr>
                    </table>
                    <ul class="stages-menu">
                        <li><a href="https://Saito-Saito-Saito.github.io/reversi/stage1/">Stage 1　プログラムの機能を考える</a></li>
                        <li><a href="https://Saito-Saito-Saito.github.io/reversi/stage2/">Stage 2　プログラムの土台を作る</a></li>
                        <li><a href="https://Saito-Saito-Saito.github.io/reversi/stage3/">Stage 3　盤面を表すクラスの基本機能を作る</a></li>
                        <li><a href="https://Saito-Saito-Saito.github.io/reversi/stage4/">Stage 4　石をおけるか判別する機能を実装する</a></li>
                        <li><a href="https://Saito-Saito-Saito.github.io/reversi/stage5/">Stage 5　石を裏返す機能を実装する</a></li>
                        <li><a href="https://Saito-Saito-Saito.github.io/reversi/stage6/">Stage 6　パスと勝敗を判定する</a></li>
                        <li><a href="https://Saito-Saito-Saito.github.io/reversi/stage7/">Stage 7　ゲーム進行をデザインする</a></li>
                    </ul>
        </div>
        <div id="long-menu">
            <table>
                    <tr>
                            <td><a href="https://Saito-Saito-Saito.github.io/reversi/">HOME</a></td>
                            <td><label for="acd-check1">Stage 1</label></td>
                            <td><label for="acd-check2">Stage 2</label></td>
                            <td><label for="acd-check3">Stage 3</label></td>
                            <td><label for="acd-check4">Stage 4</label></td>
                            <td><label for="acd-check5">Stage 5</label></td>
                            <td><label for="acd-check6">Stage 6</label></td>
                            <td><label for="acd-check7">Stage 7</label></td>
                            <td><a href="https://Saito-Saito-Saito.github.io/reversi/code">CODE</a></td>
                    </tr>
            </table>
            <input type="checkbox" id="acd-check1" class="acd-check">
            <ul id="s1-menu" class="sections-menu">
                    <li><span><a href="https://Saito-Saito-Saito.github.io/reversi/stage1/">Stage 1　プログラムの機能を考える</a></span></li>
                    <li><a href="https://Saito-Saito-Saito.github.io/reversi/stage1/section1/">1-1　盤面の機能を考える</a></li>
                    <li><a href="https://Saito-Saito-Saito.github.io/reversi/stage1/section2/">1-2　石の操作を考える</a></li>
                    <li><a href="https://Saito-Saito-Saito.github.io/reversi/stage1/section3/">1-3　ゲーム進行を考える</a></li>
            </ul>
            <input type="checkbox" id="acd-check2" class="acd-check">
            <ul id="s2-menu" class="sections-menu">
                    <li><span><a href="https://Saito-Saito-Saito.github.io/reversi/stage2/">Stage 2　プログラムの土台を作る</a></span></li>
                    <li><a href="https://Saito-Saito-Saito.github.io/reversi/stage2/section1/">2-1　ロガーの設定をする</a></li>
                    <li><a href="https://Saito-Saito-Saito.github.io/reversi/stage2/section2/">2-2　基本的な定数を宣言する</a></li>
            </ul>
            <input type="checkbox" id="acd-check3" class="acd-check">
            <ul id="s3-menu" class="sections-menu">
                    <li><span><a href="https://Saito-Saito-Saito.github.io/reversi/stage3/">Stage 3　盤面を表すクラスの基本機能を作る</a></span></li> 
                    <li><a href="https://Saito-Saito-Saito.github.io/reversi/stage3/section1/">3-1　コンストラクタを実装する</a></li>
                    <li><a href="https://Saito-Saito-Saito.github.io/reversi/stage3/section2/">3-2　盤面を表示する機能を実装する</a></li>
            </ul>
            <input type="checkbox" id="acd-check4" class="acd-check">
            <ul id="s4-menu" class="sections-menu">
                    <li><span><a href="https://Saito-Saito-Saito.github.io/reversi/stage4/">Stage 4　石をおけるか判別する機能を実装する</a></span></li>
                    <li><a href="https://Saito-Saito-Saito.github.io/reversi/stage4/section1/">4-1　石をおけるか判別する機能をデザインする</a></li>
                    <li><a href="https://Saito-Saito-Saito.github.io/reversi/stage4/section2/">4-2　石をおけるか判別する機能を実装する</a></li>
            </ul>
            <input type="checkbox" id="acd-check5" class="acd-check">
            <ul id="s5-menu" class="sections-menu">
                    <li><span><a href="https://Saito-Saito-Saito.github.io/reversi/stage5/">Stage 5　石を裏返す機能を実装する</a></span></li>
                    <li><a href="https://Saito-Saito-Saito.github.io/reversi/stage5/section1/">5-1　石を裏返す機能をデザインする</a></li>
                    <li><a href="https://Saito-Saito-Saito.github.io/reversi/stage5/section2/">5-2　石を裏返す機能を実装する</a></li>
            </ul>
            <input type="checkbox" id="acd-check6" class="acd-check">
            <ul id="s6-menu" class="sections-menu">
                    <li><span><a href="https://Saito-Saito-Saito.github.io/reversi/stage6/">Stage 6　パスと勝敗を判定する</a></span></h3>
                    <li><a href="https://Saito-Saito-Saito.github.io/reversi/stage6/section1/">6-1　パスを判定する機能を実装する</a></p>
                    <li><a href="https://Saito-Saito-Saito.github.io/reversi/stage6/section2/">6-2　勝敗を判定する機能を実装する</a></p>
            </ul>
            <input type="checkbox" id="acd-check7" class="acd-check">
            <ul id="s7-menu" class="sections-menu">
                    <li><span><a href="https://Saito-Saito-Saito.github.io/reversi/stage7/">Stage 7　ゲーム進行をデザインする</a></span></h3>
                    <li><a href="https://Saito-Saito-Saito.github.io/reversi/stage7/section1/">7-1　初期設定する機能を実装する</a></p>
                    <li><a href="https://Saito-Saito-Saito.github.io/reversi/stage7/section2/">7-2　各種判定機能を運用する</a></p>
                    <li><a href="https://Saito-Saito-Saito.github.io/reversi/stage7/section3/">7-3　入力文字列をマス目の情報に変換する</a></p>
                    <li><a href="https://Saito-Saito-Saito.github.io/reversi/stage7/section4/">7-4　入力処理を実装する</a></p>
                    <li><a href="https://Saito-Saito-Saito.github.io/reversi/stage7/section5/">7-5　ゲームセット後の操作を実装する</a></p>
            </ul>
        </div>
    </div>

    <main>
        <section id="s4">
            <h1>Stage 5　石を裏返す機能を実装する</h1>
            <h2>5-2　石を裏返す機能を実装する</h2>
            <section class="sub-section">
                <p>とりあえずコードを見ていただきましょうか。</p>
                <div class="real-code">
                    <pre>
                        <code>
    def turn(self, player, row, col, logger=None):
        logger = logger or local_logger
        
        # out of the board
        if not (InBoard(row) and InBoard(col)):
            logger.info('OUT OF THE BOARD')
            return FAILED

        # there is already a piece
        if self.board[row][col] != EMPTY:
            logger.info('THERE IS ALREADY A PIECE')
            return FAILED

        turned = False
        # searching all the direction for available one
        for direction in WHOLE_DIRECTION:
            focused = [row + direction[ROW], col + direction[COL]]
            if not (InBoard(focused[ROW]) and InBoard(focused[COL])):
                continue
            next_piece = self.board[focused[ROW]][focused[COL]]
            logger.debug('direc = {}, next_piece = {}'.format(direction, next_piece))
            # in case available
            if next_piece == -player and self.turnjudge(player, focused[ROW], focused[COL], direction):
                while self.board[focused[ROW]][focused[COL]] == -player:
                    self.board[focused[ROW]][focused[COL]] = player
                    focused[ROW] += direction[ROW]
                    focused[COL] += direction[COL]
                    turned = True
                
        # in case a piece was turned
        if turned:
            self.board[row][col] = player
            return SUCCEEDED
        # in case any piece was not turned
        else:
            logger.info('THERE IS NO DIRECTION AVAILABLE')
            return FAILED
                        </code>
                    </pre>
                </div>
                <div class="unagi">
                    <img src="https://Saito-Saito-Saito.github.io/reversi/unagi-yellow696969/normal.JPG" alt="">
                    <div class="balloon">
                        <p>もうなんかコード長くても驚かなくなったわ</p>
                    </div>
                </div>
                <p>いい兆候です。やっとプログラミングに慣れてきましたね。</p>
            </section>
            <p class="snake-line">~~~~~~~~~~~~~~~</p>
            <section class="sub-section">
                <p>まずは引数から見ていきましょう。とは言っても turnjudge とほとんど変わらないんですが。</p>
                <table width="90%" cellpadding="10" border="1" style="max-width: 450px; margin: 0 5%; border: solid black 1px; border-collapse: collapse;">
                    <tr><td>player</td><td>石をおいたプレーヤー番号</td></tr>
                    <tr><td>row</td><td>石をおいたマスの <a href="https://Saito-Saito-Saito.github.io/reversi/memo/#row_v" class="memo" target="_new">row</a> 番号</td></tr>
                    <tr><td>col</td><td>石をおいたマスの <a href="https://Saito-Saito-Saito.github.io/reversi/memo/#col_v" class="memo" target="_new">column</a> 番号</td></tr>
                    <tr><td>logger</td><td><a href="https://Saito-Saito-Saito.github.io/memorandom/Python/logging/#logger_v" class="memo" target="_new">ロガー</a></td></tr>
                </table>
                <div class="unagi">
                    <img src="https://Saito-Saito-Saito.github.io/reversi/unagi-yellow696969/normal.JPG" alt="">
                    <div class="balloon">
                        <p>ほんと見たような表やな</p>
                    </div>
                </div>
                <p>そりゃそうですよ、これ <a href="https://Saito-Saito-Saito.github.io/reversi/stage4/section2/index.html" target="_new">4-2</a> の表のコピペみたいなもんですから。</p>
                <p>引数入れたらいつも通り<a href="https://Saito-Saito-Saito.github.io/memorandom/Python/logging/#logger_v" class="memo" target="_new">ロガー</a>を設定してあげてください。</p>
                <div class="real-code">
                    <pre>
                        <code>
    def turn(self, player, row, col, logger=None):
        <span style="font-weight: bold;">logger = logger or local_logger</span>
                        </code>
                    </pre>
                </div>
                <div class="unagi">
                    <img src="https://Saito-Saito-Saito.github.io/reversi/unagi-yellow696969/normal.JPG" alt="">
                    <div class="balloon">
                        <p>ほんと説明手抜くよなお前</p>
                    </div>
                </div>
                <p>だって前やってますから。</p>
            </section>
            <p class="snake-line">~~~~~~~~~~~~~~~</p>
            <section class="sub-section">
                <p>turnjudge で石を裏返せるか確認する前に、そんなの確認しなくても石をおけない場合を除外しましょう。指定のマス [row, col] が盤面外に出ている場合と、すでにそこに石が置かれている場合ですね。</p>
                <div class="real-code">
                    <pre>
                        <code>
        # out of the board
        if not (InBoard(row) and InBoard(col)):
            logger.info('OUT OF THE BOARD')
            return FAILED

        # there is already a piece
        if self.board[row][col] != EMPTY:
            logger.info('THERE IS ALREADY A PIECE')
            return FAILED
                        </code>
                    </pre>
                </div>
                <p>InBoard 関数は row か col かどちらかでも False を出したらアウトですから、「両方大丈夫な場合」以外は「石を置けない」FAILED をリターンします。</p>
            </section>
            <p class="snake-line">~~~~~~~~~~~~~~~</p>
            <section class="sub-section">
                <p>さて、ここからは turnjudge をしっかり使っていきますよ。</p>
                <p>とりあえず <code>turned = False</code> と書いている部分は無視していただいて結構ですので、for ループの中身を見ていきましょう。</p>
                <div class="real-code">
                    <pre>
                        <code>
        turned = False
        <span style="font-weight: bold;"># searching all the direction for available one
        for direction in WHOLE_DIRECTION:
            focused = [row + direction[ROW], col + direction[COL]]
            if not (InBoard(focused[ROW]) and InBoard(focused[COL])):
                continue
            next_piece = self.board[focused[ROW]][focused[COL]]
            logger.debug('direc = {}, next_piece = {}'.format(direction, next_piece))
            # in case available
            if next_piece == -player and self.turnjudge(player, focused[ROW], focused[COL], direction):
                while self.board[focused[ROW]][focused[COL]] == -player:
                    self.board[focused[ROW]][focused[COL]] = player
                    focused[ROW] += direction[ROW]
                    focused[COL] += direction[COL]
                    turned = True</span>
                        </code>
                    </pre>
                </div>
                <p>for ループで direction に全方向を入れてそれぞれループの中を巡らせます。</p>
                <p>まずは focused というマスを決めてあげます。「[row, col] の隣のマス」という意味です。</p>
                <div class="real-code">
                    <pre>
                        <code>
        turned = False
        # searching all the direction for available one
        for direction in WHOLE_DIRECTION:
            <span style="font-weight: bold;">focused = [row + direction[ROW], col + direction[COL]]</span>
                        </code>
                    </pre>
                </div>
                <p>この focused というマスを色々と弄るのですが、そもそも盤面外にあったらいじることができませんから、focused が盤面外の場合は再び方向選択させますので continue します。</p>
                <div class="real-code">
                    <pre>
                        <code>
            focused = [row + direction[ROW], col + direction[COL]]
            <span style="font-weight: bold;">if not (InBoard(focused[ROW]) and InBoard(focused[COL])):
                continue</span>
            next_piece = self.board[focused[ROW]][focused[COL]]
                        </code>
                    </pre>
                </div>
                <p>focused にある石を next_piece という変数に格納します。</p>
                <div class="real-code">
                    <pre>
                        <code>
            if not (InBoard(focused[ROW]) and InBoard(focused[COL])):
                continue
            <span style="font-weight: bold;">next_piece = self.board[focused[ROW]][focused[COL]]</span>
            logger.debug('direc = {}, next_piece = {}'.format(direction, next_piece))
            # in case available
                        </code>
                    </pre>
                </div>
                <p>裏返せるならこれは -player になっているはずです。とりあえずログをとっておきましょう。</p>
            </section>
            <p class="snake-line">~~~~~~~~~~~~~~~</p>
            <section class="sub-section">
                <p>さて、本格的に石を裏返します。石を裏返せる条件は</p>
                <p>
                    <ul>
                        <li>next_piece が -player である</li>
                        <li>turnjudge が True である</li>
                    </ul>
                </p>
                <p>ですよね。</p>
                <div class="real-code">
                    <pre>
                        <code>
            logger.debug('direc = {}, next_piece = {}'.format(direction, next_piece))
            # in case available
            <span style="font-weight: bold;">if next_piece == -player and self.turnjudge(player, focused[ROW], focused[COL], direction):</span>
                while self.board[focused[ROW]][focused[COL]] == -player:
                        </code>
                    </pre>
                </div>
                <p>両方ともクリアしていれば次のステップに入りましょう。focused のマスにある石を裏返します。</p>
                <div class="unagi">
                    <img src="https://Saito-Saito-Saito.github.io/reversi/unagi-yellow696969/normal.JPG" alt="">
                    <div class="balloon">
                        <p>でも focused って [row, col] の隣のマスやろ</p>
                    </div>
                </div>
                <p>ええ、ですから裏返すたびに focused を動かしていきます。</p>
                <div class="real-code">
                    <pre>
                        <code>
            if next_piece == -player and self.turnjudge(player, focused[ROW], focused[COL], direction):
                <span style="font-weight: bold;">while self.board[focused[ROW]][focused[COL]] == -player:
                    self.board[focused[ROW]][focused[COL]] = player
                    focused[ROW] += direction[ROW]
                    focused[COL] += direction[COL]</span>
                    turned = True
                        </code>
                    </pre>
                </div>
                <p>focused にあるのが相手の石なら自分の石にする、そして focused の位置を direction の方向にずらすと言うことを、自分の石にたどり着くまでやります。</p>
                <div class="unagi">
                    <img src="https://Saito-Saito-Saito.github.io/reversi/unagi-yellow696969/normal.JPG" alt="">
                    <div class="balloon">
                        <p>最後の turned ってなんやねん</p>
                    </div>
                </div>
                <p>それについては今からご説明しましょう。</p>
            </section>
            <p class="snake-line">~~~~~~~~~~~~~~~</p>
            <section class="sub-section">
                <p>さて、ここまでコーディングしてきましたけれども、実際に「石を裏返した」ということをどうやって判別しましょうか？</p>
                <div class="unagi">
                    <img src="https://Saito-Saito-Saito.github.io/reversi/unagi-yellow696969/normal.JPG" alt="">
                    <div class="balloon">
                        <p>それって調べないといけねーんか。</p>
                    </div>
                </div>
                <p>ええ、例えばこういう場合を考えてみてください。</p>
                <img src="board.png" alt="UNAVAILABLE" width="90%" style="max-width: 300px;">
                <p>黒がこの状態で d6 に石を置こうとしたとしましょう。</p>
                <div class="unagi">
                    <img src="https://Saito-Saito-Saito.github.io/reversi/unagi-yellow696969/dangerous.JPG" alt="">
                    <div class="balloon">
                        <p>待て待て待て、おめーそこに石おけねーよ</p>
                    </div>
                </div> 
                <p>ええ、そうですよね。ではそれどうやってそこに「置けない」ことを判別します？</p>
                <div class="unagi">
                    <img src="https://Saito-Saito-Saito.github.io/reversi/unagi-yellow696969/dangerous.JPG" alt="">
                    <div class="balloon">
                        <p>いや、判別って turnjudge でいいじゃねえか</p>
                    </div>
                </div>
                <p>でも turn の中で turnjudge をちゃんと使ってますから、「置けるか置けないか」を判断する<a href="https://Saito-Saito-Saito.github.io/memorandom/Python/class/#method_v" class="memo" target="_new">メソッド</a>を別に作ったら二度手間ですよね。</p>
                <div class="unagi">
                    <img src="https://Saito-Saito-Saito.github.io/reversi/unagi-yellow696969/dangerous.JPG" alt="">
                    <div class="balloon">
                        <p>まあ、そうなるな</p>
                    </div>
                </div>
                <p>turn の中では実際に石を裏返してるんですから、「マジで石を裏返したら turned を True にする」みたいな変数ほしくないですか？</p>
                <div class="unagi">
                    <img src="https://Saito-Saito-Saito.github.io/reversi/unagi-yellow696969/normal.JPG" alt="">
                    <div class="balloon">
                        <p>さっきの turned ってそう言うことだったのね</p>
                    </div>
                </div>
                <p>ええ、つまり</p>
                <table cellpadding="10" style="margin: 0 5%">
                    <tr><td>turned == True</td><td>裏返した</td></tr>
                    <tr><td>turned == False</td><td>裏返していない</td></tr>
                </table>
                <p>という判別が効きますので、turned が True なら裏返し成功、False なら失敗としてリターンすることができます。</p>
                <div class="real-code">
                    <pre>
                        <code>
        # in case a piece was turned
        if turned:
            self.board[row][col] = player
            return SUCCEEDED
        # in case any piece was not turned
        else:
            logger.info('THERE IS NO DIRECTION AVAILABLE')
            return FAILED
                        </code>
                    </pre>
                </div>
                <p>これで石を裏返す機能は全て揃いました。あとはゲームを進めるだけです。</p>
            </section>
        </section>

        <section>
            <p><a href="https://Saito-Saito-Saito.github.io/reversi/stage6/index.html">NEXT　Stage 6　パスと勝敗を判別する</a></p>
        </section>
    </main>
    
    <footer>
        <ul>
            <li>LAST UPDATE: 2020/12/23</li>
            <li><a href="https://Saito-Saito-Saito.github.io" target="_blank">解説一覧</a></li>
            <li><a href="https://github.com/Saito-Saito-Saito" target="_blank">このページの作成者の GitHub</a></li>
            <li><a href="https://twitter.com/zsops_n" target="_blank">このページの作成者の Twitter</a></li>
            <li><a href="#">トップへ</a></li>
        </ul>
    </footer>
</body>
</html>