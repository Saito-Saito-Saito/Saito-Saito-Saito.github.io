<html lang="ja">
<head>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-166967736-1"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-166967736-1');
    </script>

    <title>Pythonプログラミングで2048を作る　4-2</title>
    
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta property="og:url" content="https://Saito-Saito-Saito.github.io/2048/stage4/section2">
    <meta property="og:title" content="Pythonプログラミングで2048を作る　4-2">
    <meta name="og:description" content="Pythonプログラミングによって、ターミナル上で実行できる2048を制作します。ここでは盤面を動かすアルゴリズムを各方向ごとに分けて考えます。">
    <meta name="description" content="Pythonプログラミングによって、ターミナル上で実行できる2048を制作します。ここでは盤面を動かすアルゴリズムを各方向ごとに分けて考えます。">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="twitter:card" content="summary"/>
    <meta property="og:image" content="https://Saito-Saito-Saito.github.io/unagi-pink800000/normal.JPG">

    <link rel="icon" href="https://Saito-Saito-Saito.github.io/icon.png">
    <link rel="stylesheet" href="../../stylesheet.css">
</head>
<body>
    <header>
        <div id="title">
            <h1>Pythonプログラミングで</h1>
            <h1>2048を作る</h1>
        </div>
    </header>

    <div id="menu-bar">
        <div id="short-menu">
            <input type="checkbox" id="acd-check">
            <table>
                <tr><td><a href="https://Saito-Saito-Saito.github.io/chess">HOME</a></td><td><label for="acd-check">STAGES</label></td><td><a href="https://Saito-Saito-Saito.github.io/2048/code">CODE</a></td>
                </tr>
            </table>
            <ul class="stages-menu">
                <li><a href="https://Saito-Saito-Saito.github.io/2048/stage1">Stage 1　プログラムの機能を考える</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/2048/stage2">Stage 2　プログラムの土台を作る</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/2048/stage3">Stage 3　盤面のクラスの基本機能を作る</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/2048/stage4">Stage 4　盤面を動かす</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/2048/stage5">Stage 5　ゲームの終了を判定する</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/2048/stage6">Stage 6　ゲーム進行を実装する</a></li>
            </ul>
        </div>
        <div id="long-menu">
            <table>
                <tr>
                    <td><a href="https://Saito-Saito-Saito.github.io/chess/">HOME</a></td>
                    <td><label for="acd-check1">Stage 1</label></td>
                    <td><label for="acd-check2">Stage 2</label></td>
                    <td><label for="acd-check3">Stage 3</label></td>
                    <td><label for="acd-check4">Stage 4</label></td>
                    <td><label for="acd-check5">Stage 5</label></td>
                    <td><label for="acd-check6">Stage 6</label></td>
                    <td><a href="https://Saito-Saito-Saito.github.io/2048/code">CODE</a></td>
                </tr>
            </table>
            <input type="checkbox" id="acd-check1" class="acd-check">
            <ul id="s1-menu" class="sections-menu">
                <li><a href="https://Saito-Saito-Saito.github.io/2048/stage1">Stage 1　プログラムの機能を考える</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/2048/stage1/section1">1-1　盤面の機能を考える</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/2048/stage1/section2">1-2　動きの機能を考える</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/2048/stage1/section3">1-3　ゲーム進行の機能を考える</a></li>
            </ul>
            <input type="checkbox" id="acd-check2" class="acd-check">
            <ul id="s2-menu" class="sections-menu">
                <li><a href="https://Saito-Saito-Saito.github.io/2048/stage2">Stage 2　プログラムの土台を作る</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/2048/stage2/section1">2-1　ロガーを設定する</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/2048/stage2/section2">2-2　定数を設定する</a></li>
            </ul>
            <input type="checkbox" id="acd-check3" class="acd-check">
            <ul id="s3-menu" class="sections-menu">
                <li><a href="https://Saito-Saito-Saito.github.io/2048/stage3">Stage 3　盤面のクラスの基本機能を作る</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/2048/stage3/section1">3-1　新しい数を挿入する</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/2048/stage3/section2">3-2　コンストラクタを作る</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/2048/stage3/section3">3-3　インデックスが適正か判断する</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/2048/stage3/section4">3-4　盤面を表示する</a></li>
            </ul>
            <input type="checkbox" id="acd-check4" class="acd-check">
            <ul id="s4-menu" class="sections-menu">
                <li><a href="https://Saito-Saito-Saito.github.io/2048/stage4">Stage 4　盤面を動かす</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/2048/stage4/section1">4-1　概観を把握する</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/2048/stage4/section2">4-2　4 通りの場合わけをして盤面を動かす</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/2048/stage4/section3">4-3　場合わけを統合したメソッドを実装する</a></li>
            </ul>
            <input type="checkbox" id="acd-check5" class="acd-check">
            <ul id="s5-menu" class="sections-menu">
                <li><a href="https://Saito-Saito-Saito.github.io/2048/stage5">Stage 5　ゲームの終了を判定する</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/2048/stage5/section1">5-1　ゲームクリアを判定する</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/2048/stage5/section2">5-2　手詰まりを判定する</a></li>
            </ul>
            <input type="checkbox" id="acd-check6" class="acd-check">
            <ul id="s6-menu" class="sections-menu">
                <li><a href="https://Saito-Saito-Saito.github.io/2048/stage6">Stage 6　ゲーム進行を実装する</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/2048/stage6/section1">6-1　ゴールやサイズの設定を変更する</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/2048/stage6/section2">6-2　スタートメニューを実装する</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/2048/stage6/section3">6-3　ゲーム進行を実装する</a></li>
            </ul>
        </div>
    </div>

    <main>
        <section id="s5-2">
            <h1>Stage 4　盤面を動かす</h1>
            <h2>4-2　4 通りの場合わけをして盤面を動かす</h2>
            <section class="sub-section">
                <p>さて、ここからは実際のコーディングに入ります。<a href="../section1/index.html" target="_new">4-1</a> で考えたフローチャートと <a href="https://Saito-Saito-Saito.github.io/2048/memo/#root_v" class="memo" target="_new">root</a> や <a href="https://Saito-Saito-Saito.github.io/2048/memo/#focused_v" class="memo" target="_new">focused</a> の移動にのっとって、上下左右全ての方向についてそれぞれ場合わけし、盤面の挙動をコーディングします。</p>
                <p>ただ、今回はモノホンのコードがかなり複雑なので解説用コードを別に作りました。まずは解説用コードでイメージを掴んだあと、コーディング本番に入ります。</p>
            </section>
            <p class="snake-line">~~~~~~~~~~~~~~~</p>
            <section class="sub-section">
                <p>それでは <a href="https://Saito-Saito-Saito.github.io/2048/code/#move" target="_new">move.py</a> のファイルをご覧ください。</p>
                <div class="real-code">
                    <pre>
                        <code>
import board
from config import *


class Move(board.Board):
    def board_move(self, direction: list, *, logger=None):
        logger = logger or self.logger
        ever_moved = False
        
        # up
        if direction == UP:
            logger.debug('direction is UP')
            root = [0, 0]
            for root[COL] in range(self.size):
                for root[ROW] in range(self.size):
                    focused = [root[ROW] + 1, root[COL]]
                    while self.isInBoard(focused[ROW]):
                        # in case root == EMPTY      
                        if self.board[root[ROW]][root[COL]] == EMPTY != self.board[focused[ROW]][focused[COL]]:
                            logger.info('{}, {} &lt;- {}'.format(root[ROW], root[COL], self.board[focused[ROW]][focused[COL]]))
                            self.board[root[ROW]][root[COL]] = self.board[focused[ROW]][focused[COL]]
                            self.board[focused[ROW]][focused[COL]] = EMPTY
                            ever_moved = True
                        # in case board[root]==board[focused] (!= 0)
                        elif self.board[root[ROW]][root[COL]] == self.board[focused[ROW]][focused[COL]] != 0:
                            logger.info('{}, {} &lt;- {}'.format(root[ROW], root[COL], self.board[focused[ROW]][focused[COL]]))
                            self.board[root[ROW]][root[COL]] *= 2
                            self.board[focused[ROW]][focused[COL]] = EMPTY
                            ever_moved = True
                            break
                        elif self.board[focused[ROW]][focused[COL]] != EMPTY:
                            break
                        focused[ROW] += 1
        elif direction == DOWN:
            logger.debug('direction is DOWN')
            root = [0, 0]
            for root[COL] in range(self.size):
                for root[ROW] in range(self.size - 1, -1, -1):
                    focused = [root[ROW] - 1, root[COL]]
                    while self.isInBoard(focused[ROW]):
                        # in case root == EMPTY      
                        if self.board[root[ROW]][root[COL]] == EMPTY != self.board[focused[ROW]][focused[COL]]:
                            logger.info('{}, {} &lt;- {}'.format(root[ROW], root[COL], self.board[focused[ROW]][focused[COL]]))
                            self.board[root[ROW]][root[COL]] = self.board[focused[ROW]][focused[COL]]
                            self.board[focused[ROW]][focused[COL]] = EMPTY
                            ever_moved = True
                        # in case board[root]==board[focused] (!= 0)
                        elif self.board[root[ROW]][root[COL]] == self.board[focused[ROW]][focused[COL]] != 0:
                            logger.info('{}, {} &lt;- {}'.format(root[ROW], root[COL], self.board[focused[ROW]][focused[COL]]))
                            self.board[root[ROW]][root[COL]] *= 2
                            self.board[focused[ROW]][focused[COL]] = EMPTY
                            ever_moved = True
                            break
                        elif self.board[focused[ROW]][focused[COL]] != EMPTY:
                            break
                        focused[ROW] -= 1
        elif direction == LEFT:
            logger.debug('direction is LEFT')
            root = [0, 0]
            for root[ROW] in range(self.size):
                for root[COL] in range(self.size):
                    focused = [root[ROW], root[COL]+1]
                    while self.isInBoard(focused[COL]):
                        # in case root == EMPTY      
                        if self.board[root[ROW]][root[COL]] == EMPTY != self.board[focused[ROW]][focused[COL]]:
                            logger.info('{}, {} &lt;- {}'.format(root[ROW], root[COL], self.board[focused[ROW]][focused[COL]]))
                            self.board[root[ROW]][root[COL]] = self.board[focused[ROW]][focused[COL]]
                            self.board[focused[ROW]][focused[COL]] = EMPTY
                            ever_moved = True
                        # in case board[root]==board[focused] (!= 0)
                        elif self.board[root[ROW]][root[COL]] == self.board[focused[ROW]][focused[COL]] != 0:
                            logger.info('{}, {} &lt;- {}'.format(root[ROW], root[COL], self.board[focused[ROW]][focused[COL]]))
                            self.board[root[ROW]][root[COL]] *= 2
                            self.board[focused[ROW]][focused[COL]] = EMPTY
                            ever_moved = True
                            break
                        elif self.board[focused[ROW]][focused[COL]] != EMPTY:
                            break
                        focused[COL] += 1
        elif direction == RIGHT:
            logger.debug('direction is RIGHT')
            root = [0, 0]
            for root[ROW] in range(self.size):
                for root[COL] in range(self.size - 1, -1, -1):
                    focused = [root[ROW], root[COL] - 1]
                    while self.isInBoard(focused[COL]):
                        # in case root == EMPTY      
                        if self.board[root[ROW]][root[COL]] == EMPTY != self.board[focused[ROW]][focused[COL]]:
                            logger.info('{}, {} &lt;- {}'.format(root[ROW], root[COL], self.board[focused[ROW]][focused[COL]]))
                            self.board[root[ROW]][root[COL]] = self.board[focused[ROW]][focused[COL]]
                            self.board[focused[ROW]][focused[COL]] = EMPTY
                            ever_moved = True
                        # in case board[root]==board[focused] (!= 0)
                        elif self.board[root[ROW]][root[COL]] == self.board[focused[ROW]][focused[COL]] != 0:
                            logger.info('{}, {} &lt;- {}'.format(root[ROW], root[COL], self.board[focused[ROW]][focused[COL]]))
                            self.board[root[ROW]][root[COL]] *= 2
                            self.board[focused[ROW]][focused[COL]] = EMPTY
                            ever_moved = True
                            break
                        elif self.board[focused[ROW]][focused[COL]] != EMPTY:
                            break
                        focused[COL] -= 1
        else:
            logger.error('INPUT DIRECTION is INVALID VALUE')
            return FAILED

        if ever_moved == True:
            return SUCCEEDED
        else:
            # if no number was moved, it is game over
            logger.debug('ever_moved == False')
            return FAILED
                        </code>
                    </pre>
                </div>
                <div class="unagi">
                    <img src="../../unagi-pink800000/sweat.JPG" alt="">
                    <div class="balloon">
                        <p>量多いな...</p>
                    </div>
                </div>
                <p>これがいやだから多少複雑でも短いコードを本番で使います。</p>
            </section>
            <p class="snake-line">~~~~~~~~~~~~~~~</p>
            <section class="sub-section">
                <p>まずはいろいろ import しましょうか。</p>
                <div class="real-code">
                    <pre>
                        <code>
import board
from config import *
                        </code>
                    </pre>
                </div>
                <p>本文では Move <a href="https://Saito-Saito-Saito.github.io/memorandom/Python/class" class="memo" target="_new">クラス</a>という形で <a href="https://Saito-Saito-Saito.github.io/2048/code/#board" target="_new">board.py</a> の Board <a href="https://Saito-Saito-Saito.github.io/memorandom/Python/class" class="memo" target="_new">クラス</a>を<a href="https://Saito-Saito-Saito.github.io/memorandom/Python/class#inheritance_v" class="memo" target="_new">継承</a>しています。この中で board_move というここだけの<a href="https://Saito-Saito-Saito.github.io/memorandom/Python/class#method_v" class="memo" target="_new">メソッド</a>を定義します。</p>
                <div class="real-code">
                    <pre>
                        <code>
class Move(board.Board):
    def board_move(self, direction: list, *, logger=None):
        ...
                        </code>
                    </pre>
                </div>
                <div class="unagi">
                    <img src="../../unagi-pink800000/normal.JPG" alt="">
                    <div class="balloon">
                        <p>クラスの引数にクラス入れて継承やったな</p>
                    </div>
                </div>
                <p>そうです。その通りです。</p>
            </section>
            <p class="snake-line">~~~~~~~~~~~~~~~</p>
            <section class="sub-section">
                <p>まずは<a href="https://Saito-Saito-Saito.github.io/memorandom/Python/class#method_v" class="memo" target="_new">メソッド</a>の引数からみていきましょうか。</p>
                <div class="real-code">
                    <pre>
                        <code>
    def board_move(self, direction: list, *, logger=None):
                        </code>
                    </pre>
                </div>
                <p>direction は方向を表すリストです。<a href="../../stage2/section2/index.html" target="_new">2-2</a> で決めた UP とか LEFT などの方向を入れていきます。</p>
                <div class="unagi">
                    <img src="../../unagi-pink800000/question.JPG" alt="">
                    <div class="balloon">
                        <p>direction の後に ": list" ってつけているのはなんでなん？</p>
                    </div>
                </div>
                <p>引数の型をリストに指定するためです。int とかが入れられると、その時点でエラーを出します。</p>
                <p>別の引数 logger は<a href="https://Saito-Saito-Saito.github.io/memorandom/Python/class#method_v" class="memo" target="_new">メソッド</a>の中で使う<a href="https://Saito-Saito-Saito.github.io/memorandom/Python/logging/#logger_v" class="memo" target="_new">ロガー</a>です。</p>
                <div class="real-code">
                    <pre>
                        <code>
    def board_move(self, direction: list, *, <span style="font-weight: bold;">logger=None</span>):
                        </code>
                    </pre>
                </div>
                <p>この<a href="https://Saito-Saito-Saito.github.io/memorandom/Python/class#method_v" class="memo" target="_new">メソッド</a>の中でのログは全て logger に記録されます。</p>
                <div class="unagi">
                    <img src="../../unagi-pink800000/question.JPG" alt="">
                    <div class="balloon">
                        <p>でもデフォルト None でロガーなんてないじゃん</p>
                    </div>
                </div>
                <p>ではその解説に入りましょうか。</p>
            </section>
            <p class="snake-line">~~~~~~~~~~~~~~~</p>
            <section class="sub-section">
                <p><a href="https://Saito-Saito-Saito.github.io/memorandom/Python/class#method_v" class="memo" target="_new">メソッド</a>の中身のコードは最初こんなんになってますよね。</p>
                <div class="real-code">
                    <pre>
                        <code>
    def board_move(self, direction: list, *, logger=None):
        <span style="font-weight: bold;">logger = logger or self.logger</span> 
        ever_moved = False
                        </code>
                    </pre>
                </div>
                <p>太字で強調した logger = の部分で<a href="https://Saito-Saito-Saito.github.io/memorandom/Python/logging/#logger_v" class="memo" target="_new">ロガー</a>の設定を行なっています。</p>
                <p>もし引数に何か<a href="https://Saito-Saito-Saito.github.io/memorandom/Python/logging/#logger_v" class="memo" target="_new">ロガー</a>が入れられたら、言うまでもなく引数の<a href="https://Saito-Saito-Saito.github.io/memorandom/Python/logging/#logger_v" class="memo" target="_new">ロガー</a>を使いますよね。</p>
                <div class="unagi">
                    <img src="../../unagi-pink800000/normal.JPG" alt="">
                    <div class="balloon">
                        <p>そらそうや、使えって言ってんだからな</p>
                    </div>
                </div>
                <p>では引数に何も入れられなかった時、<code>logger or self.logger</code> の値はどうなるでしょうか。</p>
                <div class="unagi">
                    <img src="../../unagi-pink800000/normal.JPG" alt="">
                    <div class="balloon">
                        <p>logger がデフォルトで None なんだから self.logger になるな</p>
                    </div>
                </div>
                <p>ということで、引数が入れられなかった場合は self.logger を<a href="https://Saito-Saito-Saito.github.io/memorandom/Python/class#method_v" class="memo" target="_new">メソッド</a>の<a href="https://Saito-Saito-Saito.github.io/memorandom/Python/logging/#logger_v" class="memo" target="_new">ロガー</a>に使おうということになります。</p>
            </section>
            <p class="snake-line">~~~~~~~~~~~~~~~</p>
            <section class="sub-section">
                <p>次の ever_moved という変数は「数字が動いたか」を bool 型で記録しておくものです。</p>
                <div class="real-code">
                    <pre>
                        <code>
    def board_move(self, direction: list, *, logger=None):
        logger = logger or self.logger
        <span style="font-weight: bold;">ever_moved = False</span>
                        </code>
                    </pre>
                </div>
                <p>例えばこんな場合を考えてみましょう。</p>
                <figure><img src="pro-move.png" alt="UNAVAILABLE" width="90%" style="max-width: 300px;"><figcaption style="font-size: 10px; padding-left: 5%;">from https://glebbahmutov.com/2048/</figcaption></figure>
                <p>この状態から盤面を上に動かそうと思っても、全ての数字が上に上がれませんから無理ですね。こんなとき「盤面を動かせなかった」ということで FAILED をリターンしたいんですよ。</p>
                <p>そこでこの ever_moved を使うわけです。どこかしら数字が動いたらこの値を True に入れ替えて、ever_moved が True なら最後に「動かせる」ということで SUCCEEDED をリターンする、False なら FAILED をリターンする、そんな形を考えています。</p>
            </section>
            <p class="snake-line">~~~~~~~~~~~~~~~</p>
            <section class="sub-section">
                <p>ここからは上下左右各方向についてどういう動きをさせるかみていきましょう。</p>
                <p><a href="../../stage1/section2/index.html" target="_new">1-2</a> で考えた <a href="https://Saito-Saito-Saito.github.io/2048/memo/#root_v" class="memo" target="_new">root</a> と <a href="https://Saito-Saito-Saito.github.io/2048/memo/#focused_v" class="memo" target="_new">focused</a> という二つのマスの位置関係を思い出してみてください。</p>
                <div class="unagi">
                    <img src="../../unagi-pink800000/normal.JPG" alt="">
                    <div class="balloon">
                        <p>focused の数字を root に移すってやつやろ</p>
                    </div>
                </div>
                <p>そうですね。まずは上に盤面を動かす場合を考えます。direction == UP の場合です。</p>
                <div class="real-code">
                    <pre>
                        <code>
        # up
        if direction == UP:
            logger.debug('direction is UP')
            root = [0, 0]
            ...
                        </code>
                    </pre>
                </div>
                <p><a href="https://Saito-Saito-Saito.github.io/2048/memo/#root_v" class="memo" target="_new">root</a> と <a href="https://Saito-Saito-Saito.github.io/2048/memo/#focused_v" class="memo" target="_new">focused</a> の取り方はこうするんでした。</p>
                <img src="up-squares.gif" width="90%" style="max-width: 300px;">
                <p>これに沿うように <a href="https://Saito-Saito-Saito.github.io/2048/memo/#root_v" class="memo" target="_new">root</a> と <a href="https://Saito-Saito-Saito.github.io/2048/memo/#focused_v" class="memo" target="_new">focused</a> の位置を変更していきます。</p>
                <p>リストの <a href="https://Saito-Saito-Saito.github.io/2048/memo/#root_v" class="memo" target="_new">root</a> を先に宣言しておきます。</p>
                <div class="real-code">
                    <pre>
                        <code>
        # up
        if direction == UP:
            logger.debug('direction is UP')
            <span style="font-weight: bold;">root = [0, 0]</span> 
            for root[COL] in range(self.size):
                for root[ROW] in range(self.size):
                        </code>
                    </pre>
                </div>
                <p>ここでの [0, 0] という値には特に意味はなく、ただ要素数が 2 のリストを用意したにすぎません。どうせこのあと for ループで初期位置を指定しますから。</p>
            </section>
            <p class="snake-line">~~~~~~~~~~~~~~~</p>
            <section class="sub-section">
                <p><a href="../section1/index.html" target="_new">4-1</a> でお見せしたフローチャートを再掲します。</p>
                <img src="universal-flow.png" alt="" width="90%" style="max-width: 500px;">
                <p>これによればまず最初に <a href="https://Saito-Saito-Saito.github.io/2048/memo/#root_v" class="memo" target="_new">root</a> を調節する必要がありますね。<a href="https://Saito-Saito-Saito.github.io/2048/memo/#row_v" class="memo" target="_new">row</a> と <a href="https://Saito-Saito-Saito.github.io/2048/memo/#column_v" class="memo" target="_new">col</a> で分けた 2 重の for ループでしっかり回しておきます。</p>
                <div class="real-code">
                    <pre>
                        <code>
            logger.debug('direction is UP')
            root = [0, 0]
            <span style="font-weight: bold;">for root[COL] in range(self.size):
                for root[ROW] in range(self.size):</span> 
                    focused = [root[ROW] + 1, root[COL]]
                    while self.isInBoard(focused[ROW]):
                        </code>
                    </pre>
                </div>
                <p>次は <a href="https://Saito-Saito-Saito.github.io/2048/memo/#focused_v" class="memo" target="_new">focused</a> の位置を決めていきます。</p>
                <img src="up-squares.gif" width="90%" style="max-width: 300px;">
                <p>これをみていただければお分かりでしょうが、<a href="https://Saito-Saito-Saito.github.io/2048/memo/#focused_v" class="memo" target="_new">focused</a> の初期位置は <a href="https://Saito-Saito-Saito.github.io/2048/memo/#root_v" class="memo" target="_new">root</a> の真下ですね。</p>
                <div class="real-code">
                    <pre>
                        <code>
            for root[COL] in range(self.size):
                for root[ROW] in range(self.size):
                    <span style="font-weight: bold;">focused = [root[ROW] + 1, root[COL]]</span>
                    while self.isInBoard(focused[ROW]):
                        # in case root == EMPTY
                        </code>
                    </pre>
                </div>
                <p>直下の while で <a href="https://Saito-Saito-Saito.github.io/2048/memo/#focused_v" class="memo" target="_new">focused</a> を回していきますよ。とりあえず <a href="https://Saito-Saito-Saito.github.io/2048/memo/#focused_v" class="memo" target="_new">focused</a> の位置が盤面をはみでたら board の<a href="https://Saito-Saito-Saito.github.io/memorandom/Python/list/#index_v" class="memo" target="_new">インデックス</a>がエラーを鳴らしてきますので、<a href="../../stage3/section3/index.html" target="_new">3-3</a> で実装した isInBoard でループ続行を判断します。</p>
                <div class="unagi">
                    <img src="../../unagi-pink800000/normal.JPG" alt="">
                    <div class="balloon">
                        <p>これ focused[ROW] しかみてないけど、<br>column はインデックスはみ出さないかみなくてええの？</p>
                    </div>
                </div>
                <p><a href="https://Saito-Saito-Saito.github.io/2048/memo/#focused_v" class="memo" target="_new">focused</a> は <a href="https://Saito-Saito-Saito.github.io/2048/memo/#root_v" class="memo" target="_new">root</a> の真下にありますから、<a href="https://Saito-Saito-Saito.github.io/2048/memo/#column_v" class="memo" target="_new">column</a> は <a href="https://Saito-Saito-Saito.github.io/2048/memo/#root_v" class="memo" target="_new">root</a> を変えるまで変えません。</p>
            </section>
            <p class="snake-line">~~~~~~~~~~~~~~~</p>
            <section class="sub-section">
                <p>while ループの中ではとりあえず <a href="https://Saito-Saito-Saito.github.io/2048/memo/#root_v" class="memo" target="_new">root</a> と <a href="https://Saito-Saito-Saito.github.io/2048/memo/#focused_v" class="memo" target="_new">focused</a> の数を比較して</p>
                <p>
                    <ul>
                        <li><code>0 == root == focused</code></li>
                        <li><code>0 == root != focused</code></li>
                        <li><code>0 != root == focused</code></li>
                        <li><code>0 != root != focused == 0</code></li>
                        <li><code>0 != root != focused != 0</code></li>
                    </ul>
                </p>
                <p>の場合わけをします。</p>
                <p>まずは <a href="https://Saito-Saito-Saito.github.io/2048/memo/#root_v" class="memo" target="_new">root</a> == 0 != <a href="https://Saito-Saito-Saito.github.io/2048/memo/#focused_v" class="memo" target="_new">focused</a> の場合ですね。</p>
                <div class="real-code">
                    <pre>
                        <code>
                        # in case root == EMPTY      
                        if self.board[root[ROW]][root[COL]] == EMPTY != self.board[focused[ROW]][focused[COL]]:
                            logger.info('{}, {} &lt;- {}'.format(root[ROW], root[COL], self.board[focused[ROW]][focused[COL]]))
                            self.board[root[ROW]][root[COL]] = self.board[focused[ROW]][focused[COL]]
                            self.board[focused[ROW]][focused[COL]] = EMPTY
                            ever_moved = True
                        </code>
                    </pre>
                </div>
                <p>数を動かしているので ever_moved は True にしてください。また <a href="https://Saito-Saito-Saito.github.io/2048/memo/#focused_v" class="memo" target="_new">focused</a> を EMPTY にすることをお忘れなく。</p>
                <p>続いて <a href="https://Saito-Saito-Saito.github.io/2048/memo/#root_v" class="memo" target="_new">root</a> == <a href="https://Saito-Saito-Saito.github.io/2048/memo/#focused_v" class="memo" target="_new">focused</a> != 0 の場合です。</p>
                <div class="real-code">
                    <pre>
                        <code>
                        # in case board[root] == board[focused] (!= 0)
                        elif self.board[root[ROW]][root[COL]] == self.board[focused[ROW]][focused[COL]] != 0:
                            logger.info('{}, {} &lt;- {}'.format(root[ROW], root[COL], self.board[focused[ROW]][focused[COL]]))
                            self.board[root[ROW]][root[COL]] *= 2
                            self.board[focused[ROW]][focused[COL]] = EMPTY
                            ever_moved = True
                            break
                        </code>
                    </pre>
                </div>
                <p>やはりこの場合も ever_moved は True ですね。そして<a href="universal-flow.png" target="_new">フローチャート</a>の通りに数を移動させたら <a href="https://Saito-Saito-Saito.github.io/2048/memo/#root_v" class="memo" target="_new">root</a> を移動させますので、<a href="https://Saito-Saito-Saito.github.io/2048/memo/#focused_v" class="memo" target="_new">focused</a> を回す while ループを break してください。</p>
                <p>ここまでで <a href="https://Saito-Saito-Saito.github.io/2048/memo/#focused_v" class="memo" target="_new">focused</a> != 0 なのに取り扱っていないものは <a href="https://Saito-Saito-Saito.github.io/2048/memo/#root_v" class="memo" target="_new">root</a> != <a href="https://Saito-Saito-Saito.github.io/2048/memo/#focused_v" class="memo" target="_new">focused</a> ですから、こちらも break してあげましょう。</p>
                <div class="real-code">
                    <pre>
                        <code>
                        elif self.board[focused[ROW]][focused[COL]] != EMPTY:
                            break
                        </code>
                    </pre>
                </div>
                <p>ここまできたら <a href="https://Saito-Saito-Saito.github.io/2048/memo/#focused_v" class="memo" target="_new">focused</a> を動かします。盤面を上に動かすとき <a href="https://Saito-Saito-Saito.github.io/2048/memo/#focused_v" class="memo" target="_new">focused</a> は <a href="https://Saito-Saito-Saito.github.io/2048/memo/#row_v" class="memo" target="_new">row</a> を一つ下に持っていくので、こうですね。</p>
                <div class="real-code">
                    <pre>
                        <code>
                        focused[ROW] += 1
                        </code>
                    </pre>
                </div>
            </section>
            <p class="snake-line">~~~~~~~~~~~~~~~</p>
            <section class="sub-section">
                <p>同じように下・左右とやっていきましょう。先に下に盤面を動かす場合を見ていきます。<a href="https://Saito-Saito-Saito.github.io/2048/memo/#column_v" class="memo" target="_new">column</a> はどうでもいいのですが、<a href="https://Saito-Saito-Saito.github.io/2048/memo/#row_v" class="memo" target="_new">row</a> は下から上がるように見ていかないといけません。</p>
                <img src="down-squares.gif" alt="UNAVAILABLE" width="90%" style="max-width: 300px;">
                <p>したがって <a href="https://Saito-Saito-Saito.github.io/2048/memo/#root_v" class="memo" target="_new">root</a>[ROW] に関する for ループの range の引数が変わります。</p>
                <p>実際にコードをみてみましょう。UP の場合と変更があるところを太字にしてあります。</p>
                <div class="real-code">
                    <pre>
                        <code>
        <span style="font-weight: bold;">elif direction == DOWN:
            logger.debug('direction is DOWN')</span>
            root = [0, 0]
            for root[COL] in range(self.size):
                <span style="font-weight: bold;">for root[ROW] in range(self.size - 1, -1, -1):
                    focused = [root[ROW] - 1, root[COL]]</span>
                    while self.isInBoard(focused[ROW]):
                        # in case root == EMPTY      
                        if self.board[root[ROW]][root[COL]] == EMPTY != self.board[focused[ROW]][focused[COL]]:
                            logger.info('{}, {} &lt;- {}'.format(root[ROW], root[COL], self.board[focused[ROW]][focused[COL]]))
                            self.board[root[ROW]][root[COL]] = self.board[focused[ROW]][focused[COL]]
                            self.board[focused[ROW]][focused[COL]] = EMPTY
                            ever_moved = True
                        # in case board[root] == board[focused] (!= 0)
                        elif self.board[root[ROW]][root[COL]] == self.board[focused[ROW]][focused[COL]] != 0:
                            logger.info('{}, {} &lt;- {}'.format(root[ROW], root[COL], self.board[focused[ROW]][focused[COL]]))
                            self.board[root[ROW]][root[COL]] *= 2
                            self.board[focused[ROW]][focused[COL]] = EMPTY
                            ever_moved = True
                            break
                        elif self.board[focused[ROW]][focused[COL]] != EMPTY:
                            break
                        <span style="font-weight: bold;">focused[ROW] -= 1</span>
                        </code>
                    </pre>
                </div>
                <p><a href="https://Saito-Saito-Saito.github.io/2048/memo/#row_v" class="memo" target="_new">row</a> を回す for 文では <code>range(self.size - 1, -1, -1)</code> とする必要があります。<a href="https://Saito-Saito-Saito.github.io/memorandom/Python/list/#index_v" class="memo" target="_new">インデックス</a>が 0 から self.size - 1 の範囲であることに注意してください。</p>
                <p><a href="https://Saito-Saito-Saito.github.io/2048/memo/#focused_v" class="memo" target="_new">focused</a> を動かすときは <a href="https://Saito-Saito-Saito.github.io/2048/memo/#row_v" class="memo" target="_new">row</a> を下から上にあげるので -1 してください。</p>
                <p>これ以外はコピペで構いません。</p>
            </section>
            <p class="snake-line">~~~~~~~~~~~~~~~</p>
            <section class="sub-section">
                <p>左に動かす場合、右に動かす場合もそれぞれ for 文の挙動には気をつけなければなりませんね。左へ動かすときは <a href="https://Saito-Saito-Saito.github.io/2048/memo/#root_v" class="memo" target="_new">root</a> と <a href="https://Saito-Saito-Saito.github.io/2048/memo/#focused_v" class="memo" target="_new">focused</a> はこうします。</p>
                <img src="left-squares.gif" alt="UNAVAILABLE" width="90%" style="max-width: 300px;">
                <p>つまり先ほどまでの <a href="https://Saito-Saito-Saito.github.io/2048/memo/#row_v" class="memo" target="_new">row</a> の代わりに <a href="https://Saito-Saito-Saito.github.io/2048/memo/#focused_v" class="memo" target="_new">focused</a> の <a href="https://Saito-Saito-Saito.github.io/2048/memo/#column_v" class="memo" target="_new">column</a> を動かさなければいけないんです。それも <a href="https://Saito-Saito-Saito.github.io/2048/memo/#column_v" class="memo" target="_new">column</a> の値が増える方向にですよ。右に行くほど <a href="https://Saito-Saito-Saito.github.io/2048/memo/#column_v" class="memo" target="_new">column</a> の値が増えるように print <a href="https://Saito-Saito-Saito.github.io/memorandom/Python/class/#method_v" class="memo" target="_new">メソッド</a>で実装しているんですから。忘れた方は <a href="../../stage3/section4/index.html" target="_new">3-4</a> でもう一度確認してください。</p>
                <p>ではコードをみてみましょう。UP と比較して変わったところを太字にします。</p>
                <div class="real-code">
                    <pre>
                        <code>
        <span style="font-weight: bold;">elif direction == LEFT:
            logger.debug('direction is LEFT')</span>
            root = [0, 0]
            <span style="font-weight: bold;">for root[ROW] in range(self.size):
                for root[COL] in range(self.size):
                    focused = [root[ROW], root[COL]+1]
                    while self.isInBoard(focused[COL]):</span>
                        # in case root == EMPTY      
                        if self.board[root[ROW]][root[COL]] == EMPTY != self.board[focused[ROW]][focused[COL]]:
                            logger.info('{}, {} &lt;- {}'.format(root[ROW], root[COL], self.board[focused[ROW]][focused[COL]]))
                            self.board[root[ROW]][root[COL]] = self.board[focused[ROW]][focused[COL]]
                            self.board[focused[ROW]][focused[COL]] = EMPTY
                            ever_moved = True
                        # in case board[root] == board[focused] (!= 0)
                        elif self.board[root[ROW]][root[COL]] == self.board[focused[ROW]][focused[COL]] != 0:
                            logger.info('{}, {} &lt;- {}'.format(root[ROW], root[COL], self.board[focused[ROW]][focused[COL]]))
                            self.board[root[ROW]][root[COL]] *= 2
                            self.board[focused[ROW]][focused[COL]] = EMPTY
                            ever_moved = True
                            break
                        elif self.board[focused[ROW]][focused[COL]] != EMPTY:
                            break
                        <span style="font-weight: bold;">focused[COL] += 1</span>
                        </code>
                    </pre>
                </div>
            </section>
            <p class="snake-line">~~~~~~~~~~~~~~~</p>
            <section class="sub-section">
                <p>右に動かす時の <a href="https://Saito-Saito-Saito.github.io/2048/memo/#root_v" class="memo" target="_new">root</a> と <a href="https://Saito-Saito-Saito.github.io/2048/memo/#focused_v" class="memo" target="_new">focused</a> の動きも欲しいんですか？仕方ないですね。</p>
                <img src="right-squares.gif" alt="UNAVAILABLE" width="90%" style="max-width: 300px;">
                <div class="unagi">
                    <img src="../../unagi-pink800000/normal.JPG" alt="">
                    <div class="balloon">
                        <p>ツンデレかよめんどくせぇ</p>
                    </div>
                </div>
                <p>これに基づいてコーディングするとこうなりますね。</p>
                <div class="real-code">
                    <pre>
                        <code>
        <span style="font-weight: bold;">elif direction == RIGHT:
            logger.debug('direction is RIGHT')</span>
            root = [0, 0]
            <span style="font-weight: bold;">for root[ROW] in range(self.size):
                for root[COL] in range(self.size - 1, -1, -1):
                    focused = [root[ROW], root[COL] - 1]
                    while self.isInBoard(focused[COL]):</span>
                        # in case root == EMPTY      
                        if self.board[root[ROW]][root[COL]] == EMPTY != self.board[focused[ROW]][focused[COL]]:
                            logger.info('{}, {} &lt;- {}'.format(root[ROW], root[COL], self.board[focused[ROW]][focused[COL]]))
                            self.board[root[ROW]][root[COL]] = self.board[focused[ROW]][focused[COL]]
                            self.board[focused[ROW]][focused[COL]] = EMPTY
                            ever_moved = True
                        # in case board[root]==board[focused] (!= 0)
                        elif self.board[root[ROW]][root[COL]] == self.board[focused[ROW]][focused[COL]] != 0:
                            logger.info('{}, {} &lt;- {}'.format(root[ROW], root[COL], self.board[focused[ROW]][focused[COL]]))
                            self.board[root[ROW]][root[COL]] *= 2
                            self.board[focused[ROW]][focused[COL]] = EMPTY
                            ever_moved = True
                            break
                        elif self.board[focused[ROW]][focused[COL]] != EMPTY:
                            break
                        <span style="font-weight: bold;">focused[COL] -= 1</span>
                        </code>
                    </pre>
                </div>
            </section>
            <p class="snake-line">~~~~~~~~~~~~~~~</p>
            <section class="sub-section">
                <p>上下左右以外の値が direction に与えられている場合はどうやって動かせばいいかわかりませんから「失敗」FAILED をリターンします。</p>
                <div class="real-code">
                    <pre>
                        <code>
        else:
            logger.error('INPUT DIRECTION is INVALID VALUE')
            return FAILED
                        </code>
                    </pre>
                </div>
                <p>他のすべての場合でもリターンしましょう。ここで、ever_moved を宣言した理由を思い出してください。動かせる数字がどこにもないかもしれなかったんですよね。ですから一つでも数字が動いていれば True を、数字が一切動いていなければ「失敗」False をリターンします。</p>
                <div class="real-code">
                    <pre>
                        <code>
        if ever_moved == True:
            return SUCCEEDED
        else:
            # if no number was moved, it is game over
            logger.debug('ever_moved == False')
            return FAILED
                        </code>
                    </pre>
                </div>
                <p>失敗したときは<a href="https://Saito-Saito-Saito.github.io/memorandom/Python/logging" class="memo" target="_new">ログ</a>で「ever_moved が False だから」と書いてあげるのがいいでしょう。</p>
            </section>
            <p class="snake-line">~~~~~~~~~~~~~~~</p>
            <section class="sub-section">
                <p>さて、ここまでで一通りコーディングはおわりました。バグがないか一応チェックしておきましょう。<a href="https://Saito-Saito-Saito.github.io/memorandom/Python/class" class="memo" target="_new">クラス</a>の外、<code>if __name__ == ...</code> というところがありますよね。</p>
                <div class="real-code">
                    <pre>
                        <code>
if __name__ == "__main__":
    test_board = Move()
    test_board.print()

    test_board.board_move(UP)
    test_board.insert()
    test_board.print()
    test_board.board_move(DOWN)
    test_board.insert()
    test_board.print()
    test_board.board_move(LEFT)
    test_board.insert()
    test_board.print()
    test_board.board_move(RIGHT)
    test_board.insert()
    test_board.print()
                        </code>
                    </pre>
                </div>
                <p>ここでは実際のゲームと同じように</p>
                <p>
                    <ul>
                        <li>動かす</li>
                        <li>入れる</li>
                        <li>見せる</li>
                    </ul>
                </p>
                <p>のスリーステップをすべての方向で実装しています。このようにして動かしてみて、</p>
                <div class="unagi">
                    <img src="../../unagi-pink800000/question.JPG" alt="">
                    <div class="balloon">
                        <p>あれ？なんかちげーな</p>
                    </div>
                </div>
                <p>となったら今すぐにデバッグへ直行してください。</p>
                <p>今回のコード、コピペ部分があまりにも多いですよね。これ、コードとしてはあまりよろしくないので、上下左右 4 方向を全て一つにまとめようと思います。そのため、ここでのデバッグは特に神経注いでください。</p>
                <div class="unagi">
                    <img src="../../unagi-pink800000/normal.JPG" alt="">
                    <div class="balloon">
                        <p>え〜、めんどくさ</p>
                    </div>
                </div>
                <p>こんなに具体的なコードでバグが発生するようだと、次に抽象化したら一気に</p>
                <div class="unagi">
                    <img src="../../unagi-pink800000/question.JPG" alt="">
                    <div class="balloon">
                        <p>どこバグってんだ？？</p>
                    </div>
                </div>
                <p>と訳わからんくなりますよ。</p>
            </section>
        </section>

        <section>
            <p><a href="../section3/index.html">NEXT　4-3　場合わけを統合したメソッドを実装する</a></p>
        </section>
    </main>

    <footer>
        <ul>
            <li>LAST UPDATE: 2020/09/25</li>
            <li><a href="https://Saito-Saito-Saito.github.io" target="_blank">解説一覧</a></li>
            <li><a href="https://github.com/Saito-Saito-Saito" target="_blank">このページの作成者のGitHub</a></li>
            <li><a href="https://twitter.com/zsops_n" target="_blank">このページの作成者のTwitter</a></li>
            <li><a href="#">トップに戻る</a></li>
        </ul>
    </footer>
</body>
</html>