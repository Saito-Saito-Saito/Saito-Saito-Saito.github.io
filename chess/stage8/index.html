<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>これであなたもチェスが作れる 8</title>
    <link rel="stylesheet" href="../stylesheet.css">
</head>
<body>
    <header>
        <div id="title">
            <h1>これであなたも</h1>
            <h1>チェスが作れる</h1>
        </div>
        <ul>
            <li><a href="../index.html">Stage 0&1</a></li>
            <li><a href="../stage2/index.html">Stage 2</a></li>
            <li><a href="../stage3/index.html">Stage 3</a></li>
            <li><a href="../stage4-1/index.html">Stage 4-1</a></li>
            <li><a href="../stage4-2/index.html">Stage 4-2</a></li>
            <li><a href="../stage5/index.html">Stage 5</a></li>
            <li><a href="../stage6/index.html">Stage 6</a></li>
            <li><a href="../stage7/index.html">Stage 7</a></li>
            <li><a href="#">Stage 8</a></li>
            <li><a href="../stage9/index.html">Stage 9</a></li>
            <li><a href="https://github.com/Saito-Saito-Saito/chess" target="_blank">Code</a></li>
        </ul>
    </header>

    <div class="acd-menu">
        <input type="checkbox" id="acd-check">
        <label for="acd-check" class="acd-label">MENU</label>
        <ul class="acd-content">
            <li><a href="../index.html">Stage 0&1</a></li>
            <li><a href="../stage2/index.html">Stage 2</a></li>
            <li><a href="../stage3/index.html">Stage 3</a></li>
            <li><a href="../stage4-1/index.html">Stage 4-1</a></li>
            <li><a href="../stage4-2/index.html">Stage 4-2</a></li>
            <li><a href="../stage5/index.html">Stage 5</a></li>
            <li><a href="../stage6/index.html">Stage 6</a></li>
            <li><a href="../stage7/index.html">Stage 7</a></li>
            <li><a href="#">Stage 8</a></li>
            <li><a href="../stage9/index.html">Stage 9</a></li>
            <li><a href="https://github.com/Saito-Saito-Saito/chess" target="_blank">Code</a></li>
        </ul>
    </div>

    <main>
        <section>
            <h1>Stage 8　ゲーム進行を記録する</h1>
            <p>今回はゲームの棋譜を別ファイルに記録していきます。「えー、んなもんいらねーよ」そうですか。せっかく「1 手戻る」とかできるようになるのになー。お？食いついてきたな。いや、正確には Stage 9 でできるようになるんですが、Stage 8 は 9 への導入の役割も果たしてくれますから、せっかく餌に引っかかった皆さんはぜひ日の目を見られるように頑張って欲しいものです。</p>
            <p>なお、ここからはファイルへの書き込みの知識が必要になります。これできないと絶望的ですので、知らない人は回れ右。いや、ムズくないから。そんな顔しないで。</p>
        </section>

        <section class="index">
            <h2>目次</h2>
            <p>
                <ul>
                    <li><a href="#s8-1">8-1　下準備</a></li>
                    <li><a href="#s8-2">8-2　棋譜の文字列操作</a></li>
                    <li><a href="#s8-3">8-3　ファイルのフォーマット</a></li>
                    <li><a href="#s8-4">8-4　ファイルへの書き込み</a></li>
                    <li><a href="#s8-5">8-5　ゲーム上で運用</a></li>
                </ul>
            </p>
        </section>

        <section id="s8-1">
            <h2>8-1　下準備</h2>
            <p>大前提として、ファイルを操作するにはファイルの名前がわからないと手の施しようがありません。この名前を config.py で一律に決めてしまいます。ログの設定を行った後にコメントで records とある部分がそれです。MAINRECADDRESS という定数にファイルの名前 mainrecord.txt を格納しています。また Stage 9 で扱う SUBRECADDRESS も定義しています。playmode.py に移って、playmode 関数の最初の記述、ここでファイルを書き込みモードで open することにより、playmode 起動時点でひょっとすると存在しないかもしれない MAINRECADDRESS (及び SUBRECADDRESS) を新規作成します。</p>
        </section>
        
        <section id="s8-2">
            <h2>8-2　棋譜の文字列操作</h2>
            <p>board.py ファイルの Board クラスに record メソッドがありますね。ここで self.s を棋譜としてファイルに記述する作業を行います。そのために <a href="../stage6/index.html#s6-1">6-1</a> でやったように、self.s から不要な文字を取り除いて、棋譜として残すのにふさわしい形にします。ですから 6-1 と同じことをします。ほんとに同じです。コピペで結構です。私もコピペしました。</p>
            <p>それが終わったら s_record という文字列変数に棋譜を格納します。キャスリングは "O" を用いるのがが本来の形ですけれども、私のコードでは "0-0-0" や "o-o" と言った形も許容していますので、「キャスリング該当の場合に限り」"o" と "0" を "O" へ変換します。キャスリングでない場合に 0 → O (ゼロからオー)の変換をすると、勝敗を表す "1-0", "0-1" にまで影響が及びますので注意してください。</p>
        </section>

        <section id="s8-3">
            <h2>8-3　ファイルのフォーマット</h2>
            <p>ファイルへの記述方法はこんな感じになります。</p>
            <p>
                <pre>
1       e4          c5          
2       Qg4         Qa5         
3       e5          d5          
4       exd6        exd6        
5       Qe4+        Be6         
6       Nf3         Nc6         
7       d3          O-O-O       
8       0-1
                </pre>
            </p>
            <p>もう一つ例を見てみましょう。</p>
            <p>
                <pre>
1       e4          c5          
2       Qh5         f5          
3       Qxe8        1-0  
                </pre>
            </p>
            <p>お分かりいただけたでしょうか。要は</p>
            <p>
                <ul>
                    <li>ターン毎に数字をふる</li>
                    <li>白は左、黒は右</li>
                    <li>列の左端をそろえる</li>
                </ul>
            </p>
            <p>ということに注意しろってわけです。簡単でしょ。</p>
        </section>
        
        <section id="s8-4">
            <h2>8-4　ファイルへの書き込み</h2>
            <p>まずはファイルを開きましょうか。record メソッドの引数で入れた address を使ってファイルを f = open ... とします。playmode では駒を動かすたびにこの record メソッドを発動させることを想定していますから、モードは追記 "a" です。</p>
            <p>ここからは書き込む内容によってフォーマット調整が入ります。まず白が勝った時。この場合上の例でも確認しましたが、1-0 と書くのは黒側ですから、f.write でそのまま追記すれば問題ありません。一方黒が勝った時は新しくターン番号を入れています。self.turn は 1 スタートです。</p>
            <p>その下にいきましょう。playmode では move の発動後に record を使います。<a href="../stage4-2/index.html#s4-2-6">4-2-6</a> でやりましたけれども、move ではパラメーターを変換するところで既にプレーヤーを入れ替えています。そのためコメントにも書いてある通り、</p>
            <p class="stress">self.player は相手</p>
            <p>です。したがって白の操作を記述するのは -self.player == WHITE の場合ですから、充分注意してください。白の場合は「ターン番号 + タブ + s_record (12 字)」を、黒のときは「s_record (12 字) + 改行」を書き込みます。これで上にあげたようなフォーマットになりますので確認してください。</p>
            <p>ファイルへの書き込みが終わったらファイルを閉じるのを忘れないでください。f.close です。</p>
        </section>

        <section id="s8-5">
            <h2>8-5　ゲーム上で運用</h2>
            <p>さて、record を実際にゲーム上で作動させましょう。playmode.py のファイルにいって playmode 関数内の while ループで BOARDprint した後です。つまりループ末端。ここで MAINRECADDRESS に操作を記述します。やることは簡単。main_board の record メソッドを引数 MAINRECADDRESS で作動させるだけ。これで駒の動きがファイルに記入されます。</p>
            <p>ゲームが終わったら勝敗を記入していきましょう。ループを抜けて winner で条件分岐している場所です。勝敗を表す "1-0", "0-1", "1/2-1/2" を入れます。ここで一つ面倒があって、引き分けのときは player を入れ替える必要があります。「えっ、なんで」ってなりますよね。しっかり順を追ってみていきましょうか。</p>
            <p>まず break した時点で main_board.player は本来駒を動かす予定だった人ですね。しかし一方で、record メソッドは元々 move した後に使用するのを意図してコーディングされています。つまり手番の player の位置に記録をつけたいなら record 内部では -player で作業しなければならない。したがって引き分けの時は player を入れ替えています。</p>
            <p>ところがどちらかが勝った場合は player の入れ替えをしていません。というのも record メソッドでは "1-0", "0-1" を処理する場合には player について何も考えていないからです。record メソッド内部をご覧になればお分かりいただけるでしょう。ファイルを開いた直後でそれぞれ場合分けしていますが、player なんてどこにもないでしょ。</p>
            <p>playmode 関数に戻っていただいて、勝敗を書いた後の記述にいきます。ここではプレーヤーに「お前らの棋譜欲しいか」と尋ねています。ここで "y" が入力されればファイルを読み取りモードで開いて内容を全部書き出します。</p>
        </section>

        <section>
            <h2>次回予告</h2>
            <p>冒頭でもお話ししましたが、記録機能をつけることで「前に戻る」という機能を加えることができます。次回はそれも含めて実装します。</p>
            <p>そもそも私がこの機能を装填したのは別の、もっと切実な理由があったからです。皆さんはどのようにデバッグなさっているか分かりませんけれども、私はチェスマスターの棋譜をいちいち手で入力して「どこかにバグはいねえか、どこかにバグはいねえか」と半ばナマハゲになってミスったとこ探してたんですが、これがまあ面倒で面倒で。なので「対局の棋譜が与えられたらゲームが完全再現できる」機能が欲しかったんです。ですから、最初はこの「全体の棋譜から対局を再現する」のに注力しています。戻る機能は副次的なものです。逆に言えば簡単なので、そう力まないで。</p>
            <p><a href="../stage9/index.html">次回　Stage 9　記録からゲームをすすめる</a></p>
        </section>
    </main>

    <footer>
        <ul>
            <li>LAST EDITED: 2020/5/6</li>
            <li><a href="../../index.html">解説一覧</a></li>
            <li>
                <a href="https://github.com/Saito-Saito-Saito" target="_blank">このページの作成者のGitHub</a>
            </li>
            <li>
                <a href="https://twitter.com/zsops_n" target="_blank">このページの作成者のTwitter</a>
            </li>
            <li>
                <a href="#">トップに戻る</a>
            </li>
        </ul>
    </footer>
</body>
</html>