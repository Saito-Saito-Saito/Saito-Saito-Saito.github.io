<html lang="ja">
<head>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-166967736-1"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-166967736-1');
    </script>
    
    <title>Pythonプログラミングでチェスを作る 7-7</title>

    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta property="og:url" content="https://Saito-Saito-Saito.github.io/chess/stage7/section7">
    <meta property="og:title" content="Pythonプログラミングでチェスを作る 7-7">
    <meta name="og:description" content="Pythonプログラミングによって、ターミナル上で棋譜を使って実行できるチェスのゲームで、移動元のマスを一つに絞り込みます。">
    <meta name="description" content="Pythonプログラミングによって、ターミナル上で棋譜を使って実行できるチェスのゲームで、移動元のマスを一つに絞り込みます。">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="twitter:card" content="summary">
    <meta property="og:image" content="https://Saito-Saito-Saito.github.io/chess/unagi-purple483d8b/normal.JPG">
    <meta name="google-site-verification" content="d3cz5KLnsS_25m1Shebvuyb3C4FfyoFNlPXdQ3z_oXg" />

    <link rel="icon" href="https://Saito-Saito-Saito.github.io/icon.png">
    <link rel="stylesheet" href="https://Saito-Saito-Saito.github.io/chess/stylesheet.css">
</head>
<body>
    <header>
        <img src="../../unagi-top.png" alt="" width="90px">
        <div id="title">
            <h1>Pythonプログラミングで</h1>
            <h1>チェスを作る</h1>
        </div>
    </header>

    <div id="menu-bar">
        <div id="short-menu">
            <input type="checkbox" id="acd-check">
            <table>
                <tr><td><a href="https://Saito-Saito-Saito.github.io/chess">HOME</a></td><td><label for="acd-check">STAGES</label></td><td><a href="https://Saito-Saito-Saito.github.io/chess/code">CODE</a></td></tr>
            </table>
            <ul class="stages-menu">
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage1/index.html">Stage 1　プログラムの機能を考える</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage2/index.html">Stage 2　プログラムの土台を作る</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage3/index.html">Stage 3　盤面のクラスの基本機能を作る</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage4/index.html">Stage 4　駒の動きを判定する</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage5/index.html">Stage 5　駒を動かす</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage6/index.html">Stage 6　勝敗を判定する</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage7/index.html">Stage 7　入力の棋譜を駒の動きに変換する</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage8/index.html">Stage 8　ゲームを進行する</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage9/index.html">Stage 9　ゲーム進行を記録する</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage10/index.html">Stage 10　記録からゲームを進める</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage11/index.html">Stage 11　全体の機能を統括する</a></li>
            </ul>
        </div>
        <div id="long-menu">
            <table>
                <tr>
                    <td><a href="https://Saito-Saito-Saito.github.io/chess/">HOME</a></td>
                    <td><label for="acd-check1">Stage 1</label></td>
                    <td><label for="acd-check2">Stage 2</label></td>
                    <td><label for="acd-check3">Stage 3</label></td>
                    <td><label for="acd-check4">Stage 4</label></td>
                    <td><label for="acd-check5">Stage 5</label></td>
                    <td><label for="acd-check6">Stage 6</label></td>
                    <td><label for="acd-check7">Stage 7</label></td>
                    <td><label for="acd-check8">Stage 8</label></td>
                    <td><label for="acd-check9">Stage 9</label></td>
                    <td><label for="acd-check10">Stage 10</label></td>
                    <td><label for="acd-check11">Stage 11</label></td>
                    <td><a href="https://Saito-Saito-Saito.github.io/chess/code">CODE</a></td>
                </tr>
            </table>
            <input type="checkbox" id="acd-check1" class="acd-check">
            <ul id="s1-menu" class="sections-menu">
                <li><span><a href="https://Saito-Saito-Saito.github.io/chess/stage1/index.html">Stage 1　プログラムの機能を考える</a></span></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage1/section1/index.html">1-1　盤面の機能を考える</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage1/section2/index.html">1-2　駒の機能を考える</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage1/section3/index.html">1-3　運営の機能を考える</a></li>
            </ul>
            <input type="checkbox" id="acd-check2" class="acd-check">
            <ul id="s2-menu" class="sections-menu">
                <li><span><a href="https://Saito-Saito-Saito.github.io/chess/stage2/index.html">Stage 2　プログラムの土台を作る</a></span></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage2/section1/index.html">2-1　ロガーを設定する</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage2/section2/index.html">2-2　定数を設定する</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage2/section3/index.html">2-3　インデックスが適正か判定する機能を設定する</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage2/section4/index.html">2-4　文字を変換する機能を設定する</a></li>
            </ul>
            <input type="checkbox" id="acd-check3" class="acd-check">
            <ul id="s3-menu" class="sections-menu">
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage3/index.html">Stage 3　盤面のクラスの基本機能を作る</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage3/section1/index.html">3-1　コンストラクタを作る</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage3/section2/index.html">3-2　盤面を表示する</a></li>
            </ul>
            <input type="checkbox" id="acd-check4" class="acd-check">
            <ul id="s4-menu" class="sections-menu">
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage4/index.html">Stage 4　駒の動きを判定する</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage4/section1/index.html">4-1　全ての駒で不可能な動きを除外する</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage4/section2/index.html">4-2　ポーンの動きを判定する</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage4/section3/index.html">4-3　ルーク・ナイト・ビショップ・クイーンの動きを判定する</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage4/section4/index.html">4-4　キングの動きを判定する</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage4/section5/index.html">4-5　駒を飛び越える動きを除外する</a></li>
            </ul>
            <input type="checkbox" id="acd-check5" class="acd-check">
            <ul id="s5-menu" class="sections-menu">
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage5/index.html">Stage 5　駒を動かす</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage5/section1/index.html">5-1　動かせない場合を除外する</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage5/section2/index.html">5-2　キャスリングの例外処理をする</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage5/section3/index.html">5-3　アンパッサンの例外処理をする</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage5/section4/index.html">5-4　プロモーションの例外処理をする</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage5/section5/index.html">5-5　駒を動かす</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage5/section6/index.html">5-6　パラメーター処理をする</a></li>
            </ul>
            <input type="checkbox" id="acd-check6" class="acd-check">
            <ul id="s6-menu" class="sections-menu">
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage6/index.html">Stage 6　勝敗を判定する</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage6/section1//index.html">6-1　キングの位置を特定する</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage6/section2/index.html">6-2　チェックの数を数える</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage6/section3/index.html">6-3　チェックメイト・ステイルメイトを判定する</a></li>
            </ul>
            <input type="checkbox" id="acd-check7" class="acd-check">
            <ul id="s7-menu" class="sections-menu">
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage7/index.html">Stage 7　入力の棋譜を駒の動きに変換する</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage7/section1/index.html">7-1　不要な文字を消去する</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage7/section2/index.html">7-2　正規表現でふるいにかける</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage7/section3/index.html">7-3　動かす駒を判定する</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage7/section4/index.html">7-4　移動元のマスのヒントを整理する</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage7/section5/index.html">7-5　移動先とプロモーションを特定する</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage7/section6/index.html">7-6　移動元の候補を列挙する</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage7/section7/index.html">7-7　移動元の候補を絞り込む</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage7/section8/index.html">7-8　キャスリングの棋譜を処理する</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage7/section9/index.html">7-9　勝敗の棋譜を処理する</a></li>
            </ul>
            <input type="checkbox" id="acd-check8" class="acd-check">
            <ul id="s8-menu" class="sections-menu">
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage8/index.html">Stage 8　ゲームを進行する</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage8/section1/index.html">8-1　ゲームの初期設定をする</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage8/sectino2/index.html">8-2　ゲームセットを判定する</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage8/section3/index.html">8-3　駒の動きを入力する</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage8/section4/index.html">8-4　ヘルプを処理する</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage8/section5.index.html">8-5　リザインを処理する</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage8/section6/index.html">8-6　盤上で駒を動かす</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage8/section7/index.html">8-7　ゲームセットを処理する</a></li>
            </ul>
            <input type="checkbox" id="acd-check9" class="acd-check">
            <ul id="s9-menu" class="sections-menu">
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage9/index.html">Stage 9　ゲーム進行を記録する</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage9/section1/index.html">9-1　記録ファイルの初期設定をする</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage9/section2/index.html">9-2　棋譜から余計な文字を削除する</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage9/section3/index.html">9-3　記録ファイルに棋譜を書き込む</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage9/section4/index.html">9-4　ゲームで記録機能を運用する</a></li>
            </ul>
            <input type="checkbox" id="acd-check10" class="acd-check">
            <ul id="s10-menu" class="sections-menu">
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage10/index.html">Stage 10　記録からゲームを進める</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage10/section1/index.html">10-1　記録ファイルを読み込む</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage10/section2/index.html">10-2　棋譜の内容を解読する</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage10/section3/index.html">10-3　１手戻る機能を実装する</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage10/sectino4/index.html">10-4　棋譜からゲームを再現する機能を実装する</a></li>
            </ul>
            <input type="checkbox" id="acd-check11" class="acd-check">
            <ul id="s11-menu" class="sections-menu">
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage11/index.html">Stage 11　全体の機能を統括する</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage11/section1/index.html">11-1　各種設定を変更させる</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage11/section2/index.html">11-2　ウェルカムページを作る</a></li>
            </ul>
        </div>
    </div>

    <main>
        <section id="s7-7">
            <h1>Stage 7　入力の棋譜を駒の動きに変換する</h1>
            <h2>7-7　移動元の候補を絞り込む</h2>
            <section class="sub-section">
                <p><a href="../section6/index.html" target="_new">7-6</a> までの生ぬるい絞り込みで候補の選定は終わりません。</p>
                <div class="unagi">
                    <img src="../../unagi-purple483d8b/normal.JPG" alt="UNAVAILABLE">
                    <div class="balloon">
                        <p>別にええやろそんなムキにならんで</p>
                    </div>
                </div>
                <p>プレーヤーは動かす駒の絞り込みのために「駒をとった」とか「<a href="https://Saito-Saito-Saito.github.io/chess/memo/#checkmate_v" class="memo" target="_new">チェックメイト</a>した」などの情報を棋譜に載せてきます。それらすべての要求に応えることなくいたずらに候補を返しては、プレーヤーの思っていた動きとは違う動かし方をしてしまう恐れがあります。</p>
                <p>そこで、今度は candidates に残っているすべての候補に基づいて local_board という仮想的な盤面上で実際に駒を動かしてみて、</p>
                <p>
                    <ul>
                        <li>駒をとっているか</li>
                        <li><a href="https://Saito-Saito-Saito.github.io/chess/memo/#check" class="memo" target="_new">チェック</a>しているか</li>
                        <li><a href="https://Saito-Saito-Saito.github.io/chess/memo/#checkmate_v" class="memo" target="_new">チェックメイト</a>しているか</li>
                        <li><a href="https://Saito-Saito-Saito.github.io/chess/memo/#enpassan_v" class="memo" target="_new">アンパッサン</a>しているか</li>
                    </ul>
                </p>
                <p>を検証しています。これらのプレーヤーの指示にしたがっていない候補はすぐに candidates から下ろします。</p>
                <div class="unagi">
                    <img src="../../unagi-purple483d8b/normal.JPG" alt="UNAVAILABLE">
                    <div class="balloon">
                        <p>なんか似たようなことやった気が</p>
                    </div>
                </div>
                <p>ええ、<a href="../../stage6/section3/index.html" target="_new">6-3</a> で使った手法をここでも用いますよ。</p>
            </section>
            <p class="snake-line">~~~~~~~~~~~~~~~</p>
            <section class="sub-section">
                <p>まずは <a href="../section6/index.html" target="_new">7-6</a> で取得した候補を for ループで一つ一つみていきます。</p>
                <div class="real-code">
                    <pre>
                        <code>
            # checking all the candidates
            for reference in range(len(candidates)):
                        </code>
                    </pre>
                </div>
                <p>ループ内部では local_board という<a href="https://Saito-Saito-Saito.github.io/memorandom/Python/class/#instance_v" class="memo" target="_new">インスタンス</a>に self を完璧に複製します。</p>
                <div class="real-code">
                    <pre>
                        <code>
            # checking all the candidates
            for reference in range(len(candidates)):
               　<span style="font-weight: bold;"># copying and moving the board
                local_board = Board(board=self.board, target=self.ep_target, castl_k=self.castl_k, castl_q=self.castl_q, player=self.player, turn=self.turn, s=self.s)</span>
                local_board.move(candidates[reference][FILE], candidates[reference][RANK], toFILE, toRANK, promote)
                        </code>
                    </pre>
                </div>
                <p>そしてこの影武者で候補の通りに駒を動かして、棋譜の要求通りになっているか確認します。</p>
                <div class="real-code">
                    <pre>
                        <code>
                # copying the board
                local_board = Board(board=self.board, target=self.ep_target, castl_k=self.castl_k, castl_q=self.castl_q, player=self.player, turn=self.turn, s=self.s)
               　<span style="font-weight: bold;"># moving the candidate
                local_board.move(candidates[reference][FILE], candidates[reference][RANK], toFILE, toRANK, promote)</span>
                        </code>
                    </pre>
                </div>
            </section>
            <p class="snake-line">~~~~~~~~~~~~~~~</p>
            <section class="sub-section">
                <p>まずは駒をとっているか見ます。該当は CAPTURED が True もしくは e.p. が line に入っている場合です。</p>
                <div class="real-code">
                    <pre>
                        <code>
                # capture; searching for the opponent's piece that has disappeared
                if CAPTURED or 'e.p.' in line:
                    # normal capturing; TO is opponent's
                    if fundam.PosNeg(self.board[toFILE][toRANK]) == -self.player:
                        pass
                    # en passan to Q-side
                    elif fundam.InSize(toRANK - 1) and fundam.PosNeg(self.board[toFILE][toRANK - 1]) == -self.player and fundam.PosNeg(local_board.board[toFILE][toRANK - 1]) == EMPTY:
                        pass
                    # en passan to K-side
                    elif fundam.InSize(toRANK + 1) and fundam.PosNeg(self.board[toFILE][toRANK + 1]) == -self.player and fundam.PosNeg(local_board.board[toFILE][toRANK + 1]) == EMPTY:
                        pass
                    # here no piece can capture a piece
                    else:
                        logger.info('{} does not capture any piece'.format(candidates[reference]))
                        del candidates[reference]
                        reference -= 1  # back to the for loop's head, reference increases
                        continue
                        </code>
                    </pre>
                </div>
                <div class="unagi">
                    <img src="../../unagi-purple483d8b/sweat.JPG" alt="UNAVAILABLE">
                    <div class="balloon">
                        <p>なっっが</p>
                    </div>
                </div>
                <p>安心してください。全部やりますから。</p>
            </section>
            <p class="snake-line">~~~~~~~~~~~~~~~</p>
            <section class="sub-section">
                <p>まずは普通に相手の駒のいる位置に駒を動かして取ってしまうパターンです。動かす前の盤面での移動先には相手の駒がいるはずですね。したがって</p>
                <div class="real-code">
                    <pre>
                        <code>
                # capture; searching for the opponent's piece that has disappeared
                if CAPTURED or 'e.p.' in line:
                    # normal capturing; TO is opponent's
                    <span style="font-weight: bold;">if fundam.PosNeg(self.board[toFILE][toRANK]) == -self.player:</span>
                        pass
                        </code>
                    </pre>
                </div>
                <p>で確認することができます。</p>
                <p>相手の駒をとっていることが確認されたら pass すなわち何もしないで if を離脱します。残ったものは相手の駒をとっていませんから candidates から抹消します。ですがその前に。</p>
            </section>
            <p class="snake-line">~~~~~~~~~~~~~~~</p>
            <section class="sub-section">
                <p>相手の駒の位置に移動する場合だけでなく<a href="https://Saito-Saito-Saito.github.io/chess/memo/#enpassan_v" class="memo" target="_new">アンパッサン</a>も忘れずに検証してください。</p>
                <img src="ep.png" alt="UNAVAILABLE" width="90%" style="max-width: 300px;">
                <div class="unagi">
                    <img src="../../unagi-purple483d8b/normal.JPG" alt="UNAVAILABLE">
                    <div class="balloon">
                        <p>相手の駒の位置に行かない場合か</p>
                    </div>
                </div>
                <p><a href="https://Saito-Saito-Saito.github.io/chess/memo/#enpassan_v" class="memo" target="_new">アンパッサン</a>は<a href="https://Saito-Saito-Saito.github.io/chess/memo/#Kside_v" class="memo" target="_new">キングサイド</a>と<a href="https://Saito-Saito-Saito.github.io/chess/memo/#Qside_v" class="memo" target="_new">クイーンサイド</a>に分けて判定します。</p>
                <div class="real-code">
                    <pre>
                        <code>
                    # en passan to Q-side
                    elif fundam.InSize(toRANK - 1) and fundam.PosNeg(self.board[toFILE][toRANK - 1]) == -self.player and fundam.PosNeg(local_board.board[toFILE][toRANK - 1]) == EMPTY:
                        pass
                    # en passan to K-side
                    elif fundam.InSize(toRANK + 1) and fundam.PosNeg(self.board[toFILE][toRANK + 1]) == -self.player and fundam.PosNeg(local_board.board[toFILE][toRANK + 1]) == EMPTY:
                        pass
                        </code>
                    </pre>
                </div>
                <div class="unagi">
                    <img src="../../unagi-purple483d8b/normal.JPG" alt="UNAVAILABLE">
                    <div class="balloon">
                        <p>いや、なんで分けんのさ</p>
                    </div>
                </div>
                <p>例えばこんな時は、キングサイドにアンパッサンしているか確認しようと board[toFILE - 1][toRANK] としてしまうと、<a href="https://Saito-Saito-Saito.gothub.io/memorandom/Python/list/#index_v" class="memo" target="_new">インデックス</a>が範囲を超えているのでエラーが出て強制終了させられてしまいます。</p>
                <img src="out-board.png" alt="UNAVAILABLE" width="90%" style="max-width: 150px;">
            </section> 
            <p class="snake-line">~~~~~~~~~~~~~~~</p>
            <section class="sub-section">
                <p>さて、ここまで残った候補は手のつけようがありません。candidates から削除します。</p>
                <div class="real-code">
                    <pre>
                        <code>
                    # here no piece can capture a piece
                    else:
                        logger.info('{} does not capture any piece'.format(candidates[reference]))
                        del candidates[reference]
                        reference -= 1  # back to the for loop's head, reference increases
                        continue
                        </code>
                    </pre>
                </div>
                <p>reference を調整して for ループを続行させます。</p>
                <div class="unagi">
                    <img src="../../unagi-purple483d8b/question.JPG" alt="UNAVAILABLE">
                    <div class="balloon">
                        <p>なんで reference 調整せなあかんの</p>
                    </div>
                </div>
                <p>本来 candidates の中身はリストですが、簡単のためにこう書いてみましょう。</p>
                <p class="code"><code>candidates == [0, 1, 2, 3, 4, ...]</code></p>
                <p>この candidates を検証していって、reference == 2 のときに「この候補は不適合だ」ということが分かったとしましょう。del を使って candidates[reference] を削除すると、</p>
                <p class="code"><code>candidates == [0, 1, 3, 4, ...]</code></p>
                <p>となりますね。ところで、reference をこのままにして for ループの先頭に戻ると、1 が加えられて reference == 3 となります。次は candidates[3] == 4 を確認するんですよね？もう気付きました？</p>
                <div class="unagi">
                    <img src="../../unagi-purple483d8b/normal.JPG" alt="UNAVAILABLE">
                    <div class="balloon">
                        <p>3 ってまだみてなくね？</p>
                    </div>
                </div>
                <p>ですから、for ループの先頭に戻る前に reference から 1 引いておく必要があるんです。</p>
            </section>
            <p class="snake-line">~~~~~~~~~~~~~~~</p>
            <section class="sub-section">    
                <p>お次はチェックで候補を絞り込みます。流派によっては記譜に書いた "+" の数でダブルチェック・トリプルチェックを指定してきます。ですから line の中の "+" の数に checkcount の示す盤面上でのチェックの数が届かなかったら、</p>
                <div class="unagi">
                    <img src="../../unagi-purple483d8b/dangerous.JPG" alt="UNAVAILABLE">
                    <div class="balloon">
                        <p>チェックの数が足りねえんだよ</p>
                    </div>
                </div>
                <p>と怒られないように、候補を candidates から削除、reference を調整、ループ続行という手筈です。</p>
                <div class="real-code">
                    <pre>
                        <code>
                # check
                if line.count('+') > local_board.checkcounter(-self.player):
                    logger.info('{} is short of the number of check'.format(candidates[reference]))
                    del candidates[reference]
                    reference -= 1  # at loop's head, reference increases
                    continue
                        </code>
                    </pre>
                </div>
                <div class="unagi">
                    <img src="../../unagi-purple483d8b/normal.JPG" alt="UNAVAILABLE">
                    <div class="balloon">
                        <p>なんで checkcounter の引数は -self.player なの？</p>
                    </div>
                </div>
                <p><a href="../../stage6/section2/index.html" target="_new">6-2</a> で散々強調したじゃないですか。checkcounter の引数はチェック</p>
                <p class="stress">される側</p>
                <p>のプレーヤー番号だって。</p>
            </section>
            <p class="snake-line">~~~~~~~~~~~~~~~</p>
            <section class="sub-section">
                <p>"#" で表されるチェックメイトは単純に checkmatejudge の真偽だけで判断できます。なんて簡単なんでしょう。</p>
                <div class="real-code">
                    <pre>
                        <code>
                # checkmate
                if '#' in line and local_board.checkmatejudge(-self.player) == False:
                    logger.info('{} does not checkmate'.format(candidates[reference]))
                    del candidates[reference]
                    reference -= 1  # at loop's head, reference increases
                    continue
                        </code>
                    </pre>
                </div>
                <p>アンパッサンは「ポーンがナナメに移動しているのに、移動先に駒がない」という状態から判断します。これまた初心者に優しいねえ。</p>
                <div class="unagi">
                    <img src="../../unagi-purple483d8b/dangerous.JPG" alt="UNAVAILABLE">
                    <div class="balloon">
                        <p>さっきから喧嘩売っとんのかテメェシャクに触るんだよ</p>
                    </div>
                </div>
                <p>いえいえ、そんな滅相もない。</p>
                <div class="real-code">
                    <pre>
                        <code>
                # en passant
                if 'e.p.' in line and self.board[toFILE][toRANK] != EMPTY:
                    logger.info('{} does not en passant'.format(candidates[reference]))
                    del candidates[reference]
                    reference -= 1  # at loop's head, reference increases
                    continue
                        </code>
                    </pre>
                </div>
                <p>これで候補が絞り込まれました。</p>
            </section>
            <p class="snake-line">~~~~~~~~~~~~~~~</p>
            <section class="sub-section">
                <p>リターン作業に入ります。</p>
                <p>まず残っている候補が 1 つだけの場合は、motionjudge や move の引数の形に合わせて残った候補をリターンします。あっ、ロガーは不要ですよ。</p>
                <div class="real-code">
                    <pre>
                        <code>
            # normal return
            if len(candidates) == 1:
                logger.info('NORMALLY RETURNED')
                return [candidates[0][FILE], candidates[0][RANK], toFILE, toRANK, promote]
                        </code>
                    </pre>
                </div>
                <p>一方、候補が複数あるときは最初の候補だけをリターンします。これでプレーヤーの思い通りにならなくたって、それは駒の動き方を限定しなかったその人の落ち度ですからね。一応ログでは「他に候補がある」と警告します。</p>
                <div class="real-code">
                    <pre>
                        <code>
            # when some candidates are available
            elif len(candidates) > 1:
                logger.warning('THERE IS ANOTHER MOVE')
                return [candidates[0][FILE], candidates[0][RANK], toFILE, toRANK, promote]
                        </code>
                    </pre>
                </div>
                <p>問題は候補がない場合です。プレーヤーの指定通りに駒を動かせませんので、「移動不可能」False をリターンすることになります。</p>
                <div class="real-code">
                    <pre>
                        <code>
            # no candidates are available
            else:
                logger.info('THERE IS NO MOVE')
                return False
                        </code>
                    </pre>
                </div>
            </section>
        </section>

        <section>
            <p><a href="../section8/index.html">NEXT　7-8　勝敗の棋譜を処理する</a></p>
        </section>
    </main>

    <footer>
        <ul>
            <li>LAST UPDATE: 2020/09/10</li>
            <li><a href="https://Saito-Saito-Saito.github.io" target="_blank">解説一覧</a></li>
            <li>
                <a href="https://github.com/Saito-Saito-Saito" target="_blank">このページの作成者のGitHub</a>
            </li>
            <li>
                <a href="https://twitter.com/zsops_n" target="_blank">このページの作成者のTwitter</a>
            </li>
            <li>
                <a href="#">トップに戻る</a>
            </li>
        </ul>
    </footer>

    
</body>
</html>