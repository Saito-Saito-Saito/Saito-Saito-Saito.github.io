<html lang="ja">
<head>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-166967736-1"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-166967736-1');
    </script>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>これであなたもチェスが作れる 7</title>
    <link rel="stylesheet" href="../stylesheet.css">
</head>
<body>
    <header>
        <div id="title">
            <h1>これであなたも</h1>
            <h1>チェスが作れる</h1>
        </div>
        <ul>
            <li><a href="https://saito-saito-saito.github.io/chess">Stage 0&1</a></li>
            <li><a href="https://saito-saito-saito.github.io/chess/stage2">Stage 2</a></li>
            <li><a href="https://saito-saito-saito.github.io/chess/stage3">Stage 3</a></li>
            <li><a href="https://saito-saito-saito.github.io/chess/stage4-1">Stage 4-1</a></li>
            <li><a href="https://saito-saito-saito.github.io/chess/stage4-2">Stage 4-2</a></li>
            <li><a href="https://saito-saito-saito.github.io/chess/stage5">Stage 5</a></li>
            <li><a href="https://saito-saito-saito.github.io/chess/stage6">Stage 6</a></li>
            <li><a href="#">Stage 7</a></li>
            <li><a href="https://saito-saito-saito.github.io/chess/stage8">Stage 8</a></li>
            <li><a href="https://saito-saito-saito.github.io/chess/stage9">Stage 9</a></li>
            <li><a href="https://github.com/Saito-Saito-Saito/chess" target="_blank">Code</a></li>
        </ul>
    </header>

    <div class="acd-menu">
        <input type="checkbox" id="acd-check">
        <label for="acd-check" class="acd-label">MENU</label>
        <ul class="acd-content">
            <li><a href="https://saito-saito-saito.github.io/chess">Stage 0&1</a></li>
            <li><a href="https://saito-saito-saito.github.io/chess/stage2">Stage 2</a></li>
            <li><a href="https://saito-saito-saito.github.io/chess/stage3">Stage 3</a></li>
            <li><a href="https://saito-saito-saito.github.io/chess/stage4-1">Stage 4-1</a></li>
            <li><a href="https://saito-saito-saito.github.io/chess/stage4-2">Stage 4-2</a></li>
            <li><a href="https://saito-saito-saito.github.io/chess/stage5">Stage 5</a></li>
            <li><a href="https://saito-saito-saito.github.io/chess/stage6">Stage 6</a></li>
            <li><a href="#">Stage 7</a></li>
            <li><a href="https://saito-saito-saito.github.io/chess/stage8">Stage 8</a></li>
            <li><a href="https://saito-saito-saito.github.io/chess/stage9">Stage 9</a></li>
            <li><a href="https://github.com/Saito-Saito-Saito/chess" target="_blank">Code</a></li>
        </ul>
    </div>

    <main>
        <section id="s7">
            <h1>Stage 7　ゲームをすすめる</h1>
            <p>ようやっとここまできましたね。今回のコーディングが終われば一丁前にゲームになりますよ。なんならここで終わりにしてもいいくらいです。なんせ私のプログラムも最初はここまでで終える部分までだけだったんですから。</p>
            <p>このステージでは新たに playmode.py というファイルにコーディングしていきます。最初に python のシステム自体に入っている sys, そして Stage 6 までに作り上げた config, board, IO の 3 つのファイルをインポートします。特に config はいちいち config. ってつけんでいいようにファイル全部を宣言なしで使えるようにしておきます。</p>
        </section>

        <section class="index">
            <h2>目次</h2>
            <p>
                <ul>
                    <li><a href="#s7-1">7-1　初期設定</a></li>
                    <li><a href="#s7-2">7-2　ゲームセット</a></li>
                    <li><a href="#s7-3">7-3　動作入力</a></li>
                    <li><a href="#s7-4">7-4　特殊イベント</a></li>
                    <li><a href="#s7-5">7-5　通常イベント</a></li>
                    <li><a href="#s7-6">7-6　ゲームセット</a></li>
                </ul>
            </p>
        </section>

        <section id="s7-1">
            <h2>7-1　初期設定</h2>
            <p>ここからはほぼすべて playmode 関数の中に記述していきます。しょっぱなの record とかは Stage 8 で扱いますので、まだ触らないでくださいね。触らないでくださいね。だから</p>
            <p class="stress">触らないでくださいね。</p>
            <p>ここで最初に手をつけるのは main_board というインスタンス(クラスをオブジェクトの形に実体化したもの)の初期化部分です。この時点でコンストラクタ __init__ が実行され、board や player などの各種パラメーターが初期化されます。次いで盤面を表示します。後々出てきますけれども、このコードでは基本的に手番(ターン)が終了してから盤面を写し出しますので、これを入れておかないと、最初何もないところから「さあて、ゲームの始まりですよ。あなたどの駒動かします？」ってなります。「いや、まずは盤面見せろよ」って話ですから書き忘れないでくださいね。</p>
            <p>ここから先は while でループさせます。基本的に決着が着くまでずっと白 → 黒 → 白 → ... と続きますから、for よりも while ループが適切でしょう。</p>
        </section>

        <section id="s7-2">
            <h2>7-2　ゲームセット</h2>
            <p>まず最初にゲームが終了しているか確認します。「えー、まだ始めたばっかでしょ」じゃないんですよ。ここ while ループの中ですよ。何度も何度もこの場所には訪れるんです。ゲームが進んでいって何回もここを訪ねたあと、「あれ、これまだ while の中にいていいのかな。決着ついてたら次のターンとかねーじゃん」と素面になって考え直すには、この位置がちょうどいいんじゃないですかね。</p>
            <p><a href="https://saito-saito-saito.github.io/chess/stage2#s2-3">2-3</a> をはじめ、何度も確認していますが、チェスにおいてゲームセットの条件は 4 つ、キングを取られる・チェックメイト(詰み)・ステイルメイト・リザイン(投了)です。リザインはあとでやるとして、他の 3 つはここで済ませましょう。</p>
            <p>キングが取られているかどうかは、手番のプレーヤーのキングを king_place で見れば事足りますね。相手が駒を動かした直後ですから、相手のキングが盤上から消えていることはありえません。king_place は引数のプレーヤーのキングが盤上にないとき False をリターンします。その時は新たに winner という変数を用意し、ここでの勝者つまり -main_board.player を格納してください。決着がついた以上ループにいてはいけませんから、break してください。</p>
            <p>次にチェックメイトへ移ります。<a href="https://saito-saito-saito.github.io/chess/stage5#s5-3">5-3</a> で散々確認しましたけども、checkmatejudge は引数がチェックメイト</p>
            <p class="stress">される側</p>
            <p>ですから、ここでは main_board.player を入れます。また、もしチェックメイトだったら「あなたチェックメイトで負けですよ」とプレーヤーに教える仕組みも入れておいてください。「なんで急に負けとか言われてんの。マジわけわかんないわ。クソゲーだわ」ってことになりますから。上と同じように winner に相手を入れて break です。</p>
            <p>そしてステイルメイトです。ここでも stalematejudge はステイルメイト</p>
            <p class="stress">される側</p>
            <p>を引数にとります。プレーヤーにはステイルメイトであることを伝え、そして winner には EMPTY を入れます。ステイルメイトは引き分け扱いです。board の駒がどっちのものか判断する時に駒のないマスを引いた場合、該当のプレーヤーなしという意味で EMPTY を使うように、ここでは「勝者なし」の意味で用います。</p>
        </section>

        <section id="s7-3">
            <h2>7-3　動作入力</h2>
            <p>ついにプレーヤーサイドの一番の醍醐味、動作の入力へと移りましょう。まずは「今どちら側の手番なのか」を表示します。皆さんだってこういうのプレーしている間に「あれ、今どっちの番だっけ」ってなるでしょ。そして他にもリザイン・ヘルプ(プラスやり直し。Stage 9 で)のイベントコードを書いてます。</p>
            <p>ヘルプは IO.py の instruction 関数に書きました。ほぼほぼ <a href="https://www.chessstrategyonline.com/content/tutorials/basic-chess-concepts-chess-notation" target="_blank">www.chessstrategyonline.com</a> の記述です。許してください。一応解説を入れておくと、ヘルプを確認し終わった後にプレーヤーサイドでエンターを押さないと次にはいかないシステムになっています。逆にこれがあるおかげで「あれ、今ヘルプ出したのになんで駒動かせって催促されてんの」と混乱を引き起こさないようになっています。これが思いやりってやつですよ。わかったかい、坊や。</p>
            <p>playmode に戻りましょう。実際にプレーヤーが何か入力するのは main_board.s = input()... の部分。格納と同時に空白文字の削除と小文字 o の大文字変換を行っています。大文字の O はキャスリングで使いますが、小文字は使い道がありません。プレーヤーがキャスリングを意図して "o-o-o" などと書いた場合に許容するためです。これも思いやり。</p>
        </section>
        
        <section id="s7-4">
            <h2>7-4　特殊イベント</h2>
            <p>7-3 で登場したイベントコード "X/H(/Z)" に対処します。まずはリザイン(投了)を表す "X" です。小文字も許してあげてください。これが入力された時は main_board.player が負けを認めていますから、winner は -main_board.player です。break で while ループを脱出します。</p>
            <p>ヘルプ "H" またはその小文字 "h" が入力されたら、先ほど 7-3 にて後出しで作った IO.py の instruction 関数を発動させます。この解説を見て次も同じプレーヤーが入力しますから、continue でもう一度ループ上端に戻ってください。</p>
            <p>"Z" は Stage 9 でやります。</p>
            <p class="stress">Stage 9 でやります。</p>
            <p>これ以外の正規の入力は s_analyze メソッドで対処できますから、返り値を motion に格納して様子を探ります。まず、motion が int 型であれば返り値としてありうるのは勝者のプレーヤー番号(含 EMPTY)です。覚えてないですって。そりゃいけませんな。<a href="https://saito-saito-saito.github.io/chess/stage6#s6-8">ここですよここ</a>。あとは大体 "X" を入力した時と変わらないんですが、引き分けの時はしっかり相手の許可をとりましょう。いやね、「ちょっとこの感じ負ける気しかしないから引き分けにしとくわ」って乱発されたらたまったもんじゃないでしょう。だから必ず相手に同意するか聞いてください。</p>
        </section>

        <section id="s7-5">
            <h2>7-5　通常イベント</h2>
            <p>まず s_analyze の結果を格納している motion が False つまり「main_board.s は棋譜の体裁をなしていない」場合であれば、当然入力したプレーヤーが悪いので、「てめーがチゲーんだよ」とつっぱねてください。もちろん当人が再入力しますから、continue によってループ先頭に戻るようにします。また同様に、リストである motion の要素をひとつずつ move に入れたとき(move(*motion) は move(motion[0], motion[1], ..., motion[4]) と同義)、これが False「移動不可」をリターンした場合も同じ処置をします。私のコードではここまでを 1 つの if 文でまとめています。</p>
            <p>条件文内で move を発動した時点で駒は動いており、必要なパラメーター変換も済んでいますから、これ以上盤上をいじる必要はもうありません。最後に盤面をプレーヤーに見せてあげて、この手番はおしまいです。ここまでの while ループをちゃんと決着がつくまで続けます。</p>
            <p>だから言ってるでしょ、record 云々は Stage 8 でやるって。そんなにしつこいと</p>
            <p class="stress">モテないよ、君。</p>
        </section>

        <section id="s7-6">
            <h2>7-6　ゲームセット</h2>
            <p>なんらかの形でゲームに決着がつき、while ループを脱したところをコーディングします。「ゲームセット」くらいはプレーヤーがわかるように書いときましょうか。</p>
            <p>while ループを抜ける時に winner に勝者を格納していますから、「こっちの勝ち」とかできるわけです。player や s を調節しているのは record の方に関わってきますので</p>
            <p class="stress">Stage 8 で</p>
            <p>扱いますけれども、それ以外は特に解説することないでしょ。</p>
            <p>ちなみにチェスの棋譜では</p>
            <p>
                <ul>
                    <li>白：1-0</li>
                    <li>黒：0-1</li>
                    <li>分：1/2-1/2</li>
                </ul>
            </p>
            <p>という書き方をすることは <a href="https://saito-saito-saito.github.io/chess/stage6#s6-8">6-8</a> で解説済みです。とかいいながらここでも解説しちゃったけど。</p>
            <p>最後にもう一度 record の話があって、これで GAME OVER となります。関数の外に if __name__ ... という部分がありますが、これは「他のファイルに playmode.py がインポートされたらここはやらないで。playmode.py を動かした時はここをやって」という意味ですね。例えば「絶対 playmode.py の中にバグあるんだけど、普段は main.py でインポートして動かしてんだよな。main 立ち上げると readmode とかいろいろ面倒なの入ってくるし ...」という厄介な問題を解決してくれるので、非常に助かります。</p>
        </section>

        <section>
            <h2>次回予告</h2>
            <p>ここまでで私のチェスのプログラム第 1 段にあった機能はおそらくすべて完装されていると思います。つまりは「これだけでチェスは楽しめるよ」ってこと。「もうこれ以上はコード書きたくない」という方のために申し上げますと、ここで中断しても十分ゲームとして完成しています。お疲れ様でした。</p>
            <p>さて、まだまだ機能を増やしたい物好きの方は次回、記録をとっていきます。「えー、プレーヤーが棋譜入れてんだから記録取らなくていいじゃーん」いや、その通りですよ。その通りだからプレーヤーの入力を記録に横流 ... じゃねえや「拝借」するんです。次回はファイルに書き込みしていきますから、もし「そんなもんわかんねーよ」という方々は一度勉強してきてください。</p>
            <p><a href="https://saito-saito-saito.github.io/chess/stage8">次回　Stage 8　ゲーム進行を記録する</a></p>
        </section>
    </main>

    <footer>
        <ul>
            <li>LAST EDITED: 2020/5/6</li>
            <li><a href="https://saito-saito-saito.github.io">解説一覧</a></li>
            <li>
                <a href="https://github.com/Saito-Saito-Saito" target="_blank">このページの作成者のGitHub</a>
            </li>
            <li>
                <a href="https://twitter.com/zsops_n" target="_blank">このページの作成者のTwitter</a>
            </li>
            <li>
                <a href="#">トップに戻る</a>
            </li>
        </ul>
    </footer>
</body>
</html>