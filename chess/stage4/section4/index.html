<html lang="ja">
<head>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-166967736-1"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-166967736-1');
    </script>
    
    <title>Pythonプログラミングでチェスを作る 4-4</title>

    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="description" content="Pythonプログラミングによって、ターミナル上で棋譜を使って実行できるチェスのゲームで、キングの動きを判定する機能を実装します。">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="twitter:card" content="summary">
    <meta property="og:image" content="https://Saito-Saito-Saito.github.io/chess/unagi-purple483d8b/normal.JPG">
    <meta name="google-site-verification" content="d3cz5KLnsS_25m1Shebvuyb3C4FfyoFNlPXdQ3z_oXg" />

    <link rel="icon" href="https://Saito-Saito-Saito.github.io/icon.png">
    <link rel="stylesheet" href="https://Saito-Saito-Saito.github.io/chess/stylesheet.css">
</head>
<body>
    <header>
        <img src="../../unagi-top.png" alt="" width="90px">
        <div id="title">
            <h1>Pythonプログラミングで</h1>
            <h1>チェスを作る</h1>
        </div>
    </header>

    <div id="menu-bar">
        <div id="short-menu">
            <input type="checkbox" id="acd-check">
            <table>
                <tr><td><a href="https://Saito-Saito-Saito.github.io/chess">HOME</a></td><td><label for="acd-check">STAGES</label></td><td><a href="https://Saito-Saito-Saito.github.io/chess/code">CODE</a></td></tr>
            </table>
            <ul class="stages-menu">
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage1/index.html">Stage 1　プログラムの機能を考える</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage2/index.html">Stage 2　プログラムの土台を作る</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage3/index.html">Stage 3　盤面のクラスの基本機能を作る</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage4/index.html">Stage 4　駒の動きを判定する</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage5/index.html">Stage 5　駒を動かす</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage6/index.html">Stage 6　勝敗を判定する</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage7/index.html">Stage 7　入力の棋譜を駒の動きに変換する</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage8/index.html">Stage 8　ゲームを進行する</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage9/index.html">Stage 9　ゲーム進行を記録する</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage10/index.html">Stage 10　記録からゲームを進める</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage11/index.html">Stage 11　全体の機能を統括する</a></li>
            </ul>
        </div>
        <div id="long-menu">
            <table>
                <tr>
                    <td><a href="https://Saito-Saito-Saito.github.io/chess/">HOME</a></td>
                    <td><label for="acd-check1">Stage 1</label></td>
                    <td><label for="acd-check2">Stage 2</label></td>
                    <td><label for="acd-check3">Stage 3</label></td>
                    <td><label for="acd-check4">Stage 4</label></td>
                    <td><label for="acd-check5">Stage 5</label></td>
                    <td><label for="acd-check6">Stage 6</label></td>
                    <td><label for="acd-check7">Stage 7</label></td>
                    <td><label for="acd-check8">Stage 8</label></td>
                    <td><label for="acd-check9">Stage 9</label></td>
                    <td><label for="acd-check10">Stage 10</label></td>
                    <td><label for="acd-check11">Stage 11</label></td>
                    <td><a href="https://Saito-Saito-Saito.github.io/chess/code">CODE</a></td>
                </tr>
            </table>
            <input type="checkbox" id="acd-check1" class="acd-check">
            <ul id="s1-menu" class="sections-menu">
                <li><span><a href="https://Saito-Saito-Saito.github.io/chess/stage1/index.html">Stage 1　プログラムの機能を考える</a></span></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage1/section1/index.html">1-1　盤面の機能を考える</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage1/section2/index.html">1-2　駒の機能を考える</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage1/section3/index.html">1-3　運営の機能を考える</a></li>
            </ul>
            <input type="checkbox" id="acd-check2" class="acd-check">
            <ul id="s2-menu" class="sections-menu">
                <li><span><a href="https://Saito-Saito-Saito.github.io/chess/stage2/index.html">Stage 2　プログラムの土台を作る</a></span></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage2/section1/index.html">2-1　ロガーを設定する</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage2/section2/index.html">2-2　定数を設定する</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage2/section3/index.html">2-3　インデックスが適正か判定する機能を設定する</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage2/section4/index.html">2-4　文字を変換する機能を設定する</a></li>
            </ul>
            <input type="checkbox" id="acd-check3" class="acd-check">
            <ul id="s3-menu" class="sections-menu">
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage3/index.html">Stage 3　盤面のクラスの基本機能を作る</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage3/section1/index.html">3-1　コンストラクタを作る</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage3/section2/index.html">3-2　盤面を表示する</a></li>
            </ul>
            <input type="checkbox" id="acd-check4" class="acd-check">
            <ul id="s4-menu" class="sections-menu">
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage4/index.html">Stage 4　駒の動きを判定する</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage4/section1/index.html">4-1　全ての駒で不可能な動きを除外する</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage4/section2/index.html">4-2　ポーンの動きを判定する</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage4/section3/index.html">4-3　ルーク・ナイト・ビショップ・クイーンの動きを判定する</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage4/section4/index.html">4-4　キングの動きを判定する</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage4/section5/index.html">4-5　駒を飛び越える動きを除外する</a></li>
            </ul>
            <input type="checkbox" id="acd-check5" class="acd-check">
            <ul id="s5-menu" class="sections-menu">
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage5/index.html">Stage 5　駒を動かす</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage5/section1/index.html">5-1　動かせない場合を除外する</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage5/section2/index.html">5-2　キャスリングの例外処理をする</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage5/section3/index.html">5-3　アンパッサンの例外処理をする</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage5/section4/index.html">5-4　プロモーションの例外処理をする</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage5/section5/index.html">5-5　駒を動かす</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage5/section6/index.html">5-6　パラメーター処理をする</a></li>
            </ul>
            <input type="checkbox" id="acd-check6" class="acd-check">
            <ul id="s6-menu" class="sections-menu">
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage6/index.html">Stage 6　勝敗を判定する</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage6/section1//index.html">6-1　キングの位置を特定する</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage6/section2/index.html">6-2　チェックの数を数える</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage6/section3/index.html">6-3　チェックメイト・ステイルメイトを判定する</a></li>
            </ul>
            <input type="checkbox" id="acd-check7" class="acd-check">
            <ul id="s7-menu" class="sections-menu">
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage7/index.html">Stage 7　入力の棋譜を駒の動きに変換する</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage7/section1/index.html">7-1　不要な文字を消去する</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage7/section2/index.html">7-2　正規表現でふるいにかける</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage7/section3/index.html">7-3　動かす駒を判定する</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage7/section4/index.html">7-4　移動元のマスのヒントを整理する</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage7/section5/index.html">7-5　移動先とプロモーションを特定する</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage7/section6/index.html">7-6　移動元の候補を列挙する</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage7/section7/index.html">7-7　移動元の候補を絞り込む</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage7/section8/index.html">7-8　キャスリングの棋譜を処理する</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage7/section9/index.html">7-9　勝敗の棋譜を処理する</a></li>
            </ul>
            <input type="checkbox" id="acd-check8" class="acd-check">
            <ul id="s8-menu" class="sections-menu">
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage8/index.html">Stage 8　ゲームを進行する</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage8/section1/index.html">8-1　ゲームの初期設定をする</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage8/sectino2/index.html">8-2　ゲームセットを判定する</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage8/section3/index.html">8-3　駒の動きを入力する</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage8/section4/index.html">8-4　ヘルプを処理する</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage8/section5.index.html">8-5　リザインを処理する</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage8/section6/index.html">8-6　盤上で駒を動かす</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage8/section7/index.html">8-7　ゲームセットを処理する</a></li>
            </ul>
            <input type="checkbox" id="acd-check9" class="acd-check">
            <ul id="s9-menu" class="sections-menu">
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage9/index.html">Stage 9　ゲーム進行を記録する</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage9/section1/index.html">9-1　記録ファイルの初期設定をする</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage9/section2/index.html">9-2　棋譜から余計な文字を削除する</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage9/section3/index.html">9-3　記録ファイルに棋譜を書き込む</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage9/section4/index.html">9-4　ゲームで記録機能を運用する</a></li>
            </ul>
            <input type="checkbox" id="acd-check10" class="acd-check">
            <ul id="s10-menu" class="sections-menu">
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage10/index.html">Stage 10　記録からゲームを進める</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage10/section1/index.html">10-1　記録ファイルを読み込む</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage10/section2/index.html">10-2　棋譜の内容を解読する</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage10/section3/index.html">10-3　１手戻る機能を実装する</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage10/sectino4/index.html">10-4　棋譜からゲームを再現する機能を実装する</a></li>
            </ul>
            <input type="checkbox" id="acd-check11" class="acd-check">
            <ul id="s11-menu" class="sections-menu">
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage11/index.html">Stage 11　全体の機能を統括する</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage11/section1/index.html">11-1　各種設定を変更させる</a></li>
                <li><a href="https://Saito-Saito-Saito.github.io/chess/stage11/section2/index.html">11-2　ウェルカムページを作る</a></li>
            </ul>
        </div>
    </div>

    <main>
        <section id="s4-4">
            <h1>Stage 5　駒の動きを判定する</h1>
            <h2>4-4　キングの動きを判定する</h2>
            <section class="sub-section">
                <div class="unagi">
                    <img src="../../unagi-purple483d8b/normal.JPG" alt="UNAVAILABLE">
                    <div class="balloon">
                        <p>キングなんてタテヨコナナメに 1 マスしか動かねーんだから書くことねーだろ</p>
                    </div>
                </div>
                <p>そう単純に思ってもらっちゃ困りますね。いや、半分はあたりなんですけど。ではその半分を先に片付けてしまいましょう。</p>
                <div class="real-code">
                    <pre>
                        <code>
        # KING
        elif piece == KING:
            # normal motion (one step)
            if abs(toFILE - frFILE) &lt;= 1 and abs(toRANK - frRANK) &lt;= 1:
                logger.debug('KING NORMAL')
                return True
                        </code>
                    </pre>
                </div>
                <p>基本動作の場合は <a href="https://Saito-Saito-Saito.github.io/chess/memo/#file_v" class="memo" target="_new">file</a> と <a href="https://Saito-Saito-Saito.github.io/chess/memo/#rank_v" class="memo" target="_new">rank</a> の差が 1 以下であれば構いません。「以下」ですよ「以下」、これがないとナナメしかいけませんから。ほら、タテに進むとき <a href="https://Saito-Saito-Saito.github.io/chess/memo/#file_v" class="memo" target="_new">file</a> の差は 0 じゃないですか。</p>
                <img src="king-forward.png" alt="UNAVAILABLE" width="90%" style="max-width: 200px;">
            </section>
            <p class="snake-line">~~~~~~~~~~~~~~~</p>
            <section class="sub-section">
                <p>さて、簡単な方が終わりましたから厄介者をどうにかしましょう。</p>
                <div class="unagi">
                    <img src="../../unagi-purple483d8b/normal.JPG" alt="UNAVAILABLE">
                    <div class="balloon">
                        <p>もう書くことねーよ。終わりだ終わり</p>
                    </div>
                </div>
                <p><a href="https://Saito-Saito-Saito.github.io/chess/memo/#castling_v" class="memo" target="_new">キャスリング</a>ですよ。</p>
                <img src="castling.png" alt="UNAVAILABLE" width="90%" style="max-width: 300px;">
                <p>こいつは基本的にキングの動きとて扱うのがいちばん楽ですからね。ルークで考えると、<a href="https://Saito-Saito-Saito.github.io/chess/memo/#castling_v" class="memo" target="_new">キャスリング</a>の場合に加えて単純にルークを動かす場合がありますから、</p>
                <div class="unagi">
                    <img src="../../unagi-purple483d8b/cry.JPG" alt="UNAVAILABLE">
                    <div class="balloon">
                        <p>あっ、今キング動かしたくないのに</p>
                    </div>
                </div>
                <p>ってなったりして面倒です。</p>
                <img src="castling-or-not.png" alt="UNAVAILABLE" width="90%" style="max-width: 300px;">
                <p>この場合は<a href="https://Saito-Saito-Saito.github.io/chess/memo/#castling_v" class="memo" target="_new">キャスリング</a>すべきかどうかわかりませんよね。</p>
                <p><a href="https://Saito-Saito-Saito.github.io/chess/memo/#castling_v" class="memo" target="_new">キャスリング</a>の条件をもう一度確認してみましょうか。</p>
                <p>
                    <ul>
                        <li>キングと動かすルークを一度も動かしたことがない</li>
                        <li>キングと動かすルークの間に何もない</li>
                        <li>移動前後、移動中にキングが<a href="https://Saito-Saito-Saito.github.io/chess/memo/#check_v" class="memo" target="_new">チェック</a>されない</li>
                    </ul>
                </p>
                <div class="unagi">
                    <img src="../../unagi-purple483d8b/normal.JPG" alt="UNAVAILABLE">
                    <div class="balloon">
                        <p>めんどくせーのばっかだな</p>
                    </div>
                </div>
            </section>
            <p class="snake-line">~~~~~~~~~~~~~~~</p>
            <section class="sub-section">
                <p>条件の一番上「キングと<a href="https://Saito-Saito-Saito.github.io/chess/memo/#castling_v" class="memo" target="_new">キャスリング</a>するルークを一度も動かしたことがない」というのを判定します。そこで使っているのが castl_q/castl_k です。</p>
                <div class="unagi">
                    <img src="../../unagi-purple483d8b/normal.JPG" alt="UNAVAILABLE">
                    <div class="balloon">
                        <p>どっかで見覚えがあるようなないような</p>
                    </div>
                </div>
                <p><a href="https://Saito-Saito-Saito.github.io/memorandom/Python/class#constructor_v" class="memo" target="_new">コンストラクタ</a>をご覧ください。</p>
                <div class="real-code">
                    <pre>
                        <code>
    def __init__(self, ...
        ...
        self.ep_target = copy.deepcopy(target) # for en passan
        <span style="font-weight: bold;">self.castl_k = copy.deepcopy(castl_k)   # for castling
        self.castl_q = copy.deepcopy(castl_q)   # for castling</span>
        self.turn = turn  # starts from 1
        ...
                        </code>
                    </pre>
                </div>
                <p>castl_k, castl_q というのを定義していますよね。それぞれ<a href="https://Saito-Saito-Saito.github.io/chess/memo/#Kside_v" class="memo" target="_new">キングサイド</a>・<a href="https://Saito-Saito-Saito.github.io/chess/memo/#Qside_v" class="memo" target="_new">クイーンサイド</a>に<a href="https://Saito-Saito-Saito.github.io/chess/memo/#castling_v" class="memo" target="_new">キャスリング</a>できるプレーヤーを格納しています。リスト型で<a href="https://Saito-Saito-Saito.github.io/memorandom/Python/list#mutability" class="memo" target="_new">ミュータブル</a>ですので、引き込んだリストが変更を受けないように copy.deepcopy を使っていますね。</p>
            </section>
            <p class="snake-line">~~~~~~~~~~~~~~~</p>
            <section class="sub-section">
                <p>castl_k で具体的に見てみましょう。ゲーム開始時は両プレーヤーとも<a href="https://Saito-Saito-Saito.github.io/chess/memo/#Kside_v" class="memo" target="_new">キングサイド</a>に<a href="https://Saito-Saito-Saito.github.io/chess/memo/#castling_v" class="memo" target="_new">キャスリング</a>する資格がありますから、</p>
                <p class="code"><code>castl_k = [WHITE, BLACK]</code></p>
                <p>となります。さて、白が h1 のルークを動かしたとしましょう。</p>
                <img src="Kside-remove.png" alt="UNAVAILABLE" width="90%" style="max-width: 300px;">
                <p>こうなれば白は<a href="https://Saito-Saito-Saito.github.io/chess/memo/#Kside_v" class="memo" target="_new">キングサイド</a>に<a href="https://Saito-Saito-Saito.github.io/chess/memo/#castling_v" class="memo" target="_new">キャスリング</a>できませんから、</p>
                <p class="code"><code>castl_k = [BLACK]</code></p>
                <p>となりますよね。この後黒が<a href="https://Saito-Saito-Saito.github.io/chess/memo/#castling_v" class="memo" target="_new">キャスリング</a>すれば、もう黒もこれ以上<a href="https://Saito-Saito-Saito.github.io/chess/memo/#Kside_v" class="memo" target="_new">キングサイド</a>に<a href="https://Saito-Saito-Saito.github.io/chess/memo/#castling_v" class="memo" target="_new">キャスリング</a>できませんから</p>
                <p class="code"><code>castl_k = []</code></p>
                <p>となります。castl_q についても同じようにします。</p>
            </section>
            <p class="snake-line">~~~~~~~~~~~~~~~</p>
            <section class="sub-section">
                <p>では motionjudge に戻ってコーディングしましょう。まず player ごとに変数 rank を設定します。</p>
                <div class="real-code">
                    <pre>
                        <code>
            # preparing for castling; setting rank
            if player == WHITE:
                rank = 1 - 1
            elif player == BLACK:
                rank = 8 - 1
            else:
                logger.error('UNEXPECTED PLAYER VALUE in motionjudge')
                print('SYSTEM ERROR')
                sys.exit('SYSTEM ERROR')
                        </code>
                    </pre>
                </div>
                <p>白は第 1 <a href="https://Saito-Saito-Saito.github.io/chess/memo/#rank_v" class="memo" target="_new">rank</a> で、黒は第 8 <a href="https://Saito-Saito-Saito.github.io/chess/memo/#rank_v" class="memo" target="_new">rank</a> でしか<a href="https://Saito-Saito-Saito.github.io/chess/memo/#castling_v" class="memo" target="_new">キャスリング</a>できませんよ。ここの rank は<a href="https://Saito-Saito-Saito.gothub.io/memorandom/Python/list/#index_v" class="memo" target="_new">インデックス</a>として使いますから、- 1 をお忘れなく。</p>
                <p>お次に if で条件分岐します。まず<a href="https://Saito-Saito-Saito.github.io/chess/memo/#Qside_v" class="memo" target="_new">クイーンサイド</a>に<a href="https://Saito-Saito-Saito.github.io/chess/memo/#castling_v" class="memo" target="_new">キャスリング</a>ときの条件は</p>
                <p>
                    <ul>
                        <li>キングと a <a href="https://Saito-Saito-Saito.github.io/chess/memo/#file_v" class="memo" target="_new">file</a> のルークを一度も動かしたことがない</li>
                        <li>キングが [e - 1, rank] から [c - 1, rank] に移動する</li>
                        <li>キングと a <a href="https://Saito-Saito-Saito.github.io/chess/memo/#file_v" class="memo" target="_new">file</a> のルークの間に何もない</li>
                        <li style="opacity: 0.5;">その相手の駒が [c - 1][rank], [d - 1][rank], [e - 1][rank] のどれにも動くことができない（＝<a href="https://Saito-Saito-Saito.github.io/chess/memo/#check_v" class="memo" target="_new">チェック</a>されない）</li>
                    </ul>
                </p>
                <p>ですね。</p>
                <img src="Qside.png" alt="UNAVAILABLE" width="90%" style="max-width: 350px;">
                <p>最後の条件は if 文では検証が難しいので、それ以外の 3 つを if でまず場合わけします。</p>
                <div class="real-code">
                    <pre>
                        <code>
            # Q-side; adequate fr and to, all passing squares are EMPTY
            if player in self.castl_q and frFILE == e - 1 and frRANK == rank and toFILE == c - 1 and toRANK == rank and self.board[b - 1][rank] == self.board[c - 1][rank] == self.board[d - 1][rank] == EMPTY:
                        </code>
                    </pre>
                </div>
            </section>
            <p class="snake-line">~~~~~~~~~~~~~~~</p>
            <section class="sub-section">
                <p>一番最初の条件は castl_q に player が格納されているか、その次の条件は frFILE や toRANK が正しい値になっているか見ればいい。</p>
                <p>真ん中の条件は [b - 1, rank], [c - 1, rank], [d - 1, rank] が EMPTY であればいいですね。また<a href="https://Saito-Saito-Saito.github.io/chess/memo/#castling_v" class="memo" target="_new">キャスリング</a>するときキングは [e - 1, rank] から [c - 1, rank] に移動するので、移動元や移動先もしっかり指定しなければいけません。</p>
                <div class="unagi">
                    <img src="../../unagi-purple483d8b/normal.JPG" alt="UNAVAILABLE">
                    <div class="balloon">
                        <p>rank から 1 引かねーと... いや、元々 1 引いて宣言してるからいいのか</p>
                    </div>
                </div>
            </section>
            <p class="snake-line">~~~~~~~~~~~~~~~</p>
            <section class="sub-section">
                <p>最後の条件を検証しましょう。まずキングを狙いにくる駒のいるマスの <a href="https://Saito-Saito-Saito.github.io/chess/memo/#file_v" class="memo" target="_new">file</a> を表す変数 fil と <a href="https://Saito-Saito-Saito.github.io/chess/memo/#rank_v" class="memo" target="_new">rank</a> を表す ran を変数に 2 重の for ループで盤上全ての駒を網羅します。</p>
                <div class="real-code">
                    <pre>
                        <code>
                # K must not be checked while castling
                for ran in range(SIZE):
                    for fil in range(SIZE):
                        # piece is opponent's and reaches a square through which K moves
                        if fundam.PosNeg(self.board[fil][ran]) == -player and (self.motionjudge(fil, ran, e - 1, rank, Q) or self.motionjudge(fil, ran, d - 1, rank, Q) or self.motionjudge(fil, ran, c - 1, rank, Q)):
                            logger.info('CHECKED IN THE WAY')
                            return False
                        </code>
                    </pre>
                </div>
                <p>if 分岐は</p>
                <p>
                    <ul>
                        <li>もし [fil, ran] のマスにいるのが相手の駒で</li>
                        <li>その相手の駒が [c - 1][rank], [d - 1][rank], [e - 1][rank] のどれか一つにでも動くことができるなら「動かせない」False を返す</li>
                        <li>すべてのマスについてクリア(相手は<a href="https://Saito-Saito-Saito.github.io/chess/memo/#check_v" class="memo" target="_new">チェック</a>できない)ならば True を返す</li>
                    </ul>
                </p>
                <p>という形です。最初の条件、「相手の駒」というのは -player であらわせますね。2 番目の条件は motionjudge を使えば解決できます。</p>
                <div class="unagi">
                    <img src="../../unagi-purple483d8b/question.JPG" alt="UNAVAILABLE">
                    <div class="balloon">
                        <p>motionjudge？ここ motionjudge だよね？</p>
                    </div>
                </div>
                <p>そうです。motionjudge のなかで motionjudge を使います。ですがこの<a href="https://Saito-Saito-Saito.github.io/memorandom/Python/class#method_v" class="memo" target="_new">メソッド</a>はただ単に「ここからここに駒は動かせるか」ということを検証するものにすぎません。</p>
                <p>それにこの位置に相手のキングが来るとき、そのキングは<a href="https://Saito-Saito-Saito.github.io/chess/memo/#castling_v" class="memo" target="_new">キャスリング</a>してませんから、いわゆる再起関数のようなループはできませんよ。</p>
            </section>
            <p class="snake-line">~~~~~~~~~~~~~~~</p>
            <section class="sub-section">
                <p><a href="https://Saito-Saito-Saito.github.io/chess/memo/#Kside_v" class="memo" target="_new">キングサイド</a>についても全く同様に確認できます。こちらは<a href="https://Saito-Saito-Saito.github.io/chess/memo/#castling_v" class="memo" target="_new">キャスリング</a>可能なプレーヤーが castl_k に格納されていること、キングの行先が [g - 1][rank] になることに注意してください。</p>
                <img src="Kside.png" alt="UNAVAILABLE" width="90%" style="max-width: 350px;">
                <p>ここまでで動くことができず放置されたら、王様とはいえ動くことは許されません。すべて False をリターンしてしまいましょう。</p>
                <p>これにて駒ごとの確認はすべて終わりです。長かったですね。最後に「piece の値がこれ以外の場合」をのぞいておきましょう。</p>
                <div class="real-code">
                    <pre>
                        <code>
        # all other King's moves are invalid
        else:
            logger.error('UNEXPECTED VALUE of PIECE in motionjudge')
            print('SYSTEM ERROR')
            sys.exit('SYSTEM ERROR')
                        </code>
                    </pre>
                </div>
                <p>ポーンからキングまですべて場合分けしてんのに、まだ引っかからない得体の知れない駒は間引いておかないと。</p>
            </section>
        </section>

        <section>
            <p><a href="../section5/index.html">NEXT　4-5　駒を飛び越える動きを除外する</a></p>
        </section>
    </main>

    <footer>
        <ul>
            <li>LAST UPDATE: 2020/09/01</li>
            <li><a href="https://Saito-Saito-Saito.github.io" target="_blank">解説一覧</a></li>
            <li>
                <a href="https://github.com/Saito-Saito-Saito" target="_blank">このページの作成者のGitHub</a>
            </li>
            <li>
                <a href="https://twitter.com/zsops_n" target="_blank">このページの作成者のTwitter</a>
            </li>
            <li>
                <a href="#">トップに戻る</a>
            </li>
        </ul>
    </footer>

    
</body>
</html>