<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>これであなたもチェスが作れる 9</title>
    <link rel="stylesheet" href="../stylesheet.css">
</head>
<body>
    <header>
        <div id="title">
            <h1>これであなたも</h1>
            <h1>チェスが作れる</h1>
        </div>
        <ul>
            <li><a href="../index.html">Stage 0&1</a></li>
            <li><a href="../stage2/index.html">Stage 2</a></li>
            <li><a href="../stage3/index.html">Stage 3</a></li>
            <li><a href="../stage4-1/index.html">Stage 4-1</a></li>
            <li><a href="../stage4-2/index.html">Stage 4-2</a></li>
            <li><a href="../stage5/index.html">Stage 5</a></li>
            <li><a href="../stage6/index.html">Stage 6</a></li>
            <li><a href="../stage7/index.html">Stage 7</a></li>
            <li><a href="../stage8/index.html">Stage 8</a></li>
            <li><a href="#">Stage 9</a></li>
        </ul>
    </header>

    <main>
        <section id="s9">
            <h1>Stage 9　記録からゲームをすすめる</h1>
            <p>やっと最後です。いや、長かった。とうとうここで私のコードの説明が終わります。最後です。だから最後だっていってるでしょ。</p>
            <p>「フラグ」だなんて、あんた ONE PIECE の読みすぎですよ。ああ、フラグはエヴァで学んだんでしたか。失敬失敬。</p>
        </section>

        <section class="index">
            <h2>目次</h2>
            <p>
                <ul>
                    <li><a href="#s9-1">9-1　記録ファイルの読み込み</a></li>
                    <li><a href="#s9-2">9-2　構文解析</a></li>
                    <li><a href="#s9-3">9-3　戻る機能</a></li>
                    <li><a href="#s9-4">9-4　読込モード</a></li>
                    <li><a href="#s9-5">9-5　全体統括</a></li>
                </ul>
            </p>
        </section>

        <section id="s9-1">
            <h2>9-1　記録ファイルの読み込み</h2>
            <p>これ以降は Board クラスの tracefile メソッドにコーディングします。指定のターン・プレーヤーの手番の直前までゲームを進める機能で、引数の destination_turn, destination_player, isrecwrite はそれぞれ指定ターン、指定プレーヤー、そして記録を書き換えるかを表しています。メソッド内で local_board という Board のインスタンスを作成し、これをいじります。</p>
            <p>まず第 1 ターンで白が駒を動かす直前で操作を止める場合、まだ駒は初期配置ですから、local_board を初期設定してすぐにリターンしてください。</p>
            <p>そのほか駒の動きを要する場合は、まず SUBRECADDRESS を書き込みモードで開いた後すぐに閉じて初期化、ついで MAINRECADDRESS の中身をすべて line に読み取ってしまいます。同時に両端にある空白文字と改行文字を strip メソッドですべて消します。line には棋譜として意味のある文だけでなく、例えばターン番号を表す数字が入っているなど、無視しなければいけない文があります。無視すべき文を無視し、拾うべき文を拾う。これが tracefile に求められる機能です。</p>
            <p>それでは local_board を宣言して一文一文に目を向けていきましょう。</p>
        </section>

        <section id="s9-2">
            <h2>9-2　構文解析</h2>
            <p>さて、構文解析の時間です。どうやるかって言いますと、for 文で 1 文字ずつ letter の中に line の文字を取り込んでいきます。とりあえず local_board.s (以下 loc...s) の中にブチ込んでって、空白や改行が割り込んだら打ち切り、loc...s に残った文字列が s_analyze にうまいこと引っかかってくれるかを見ます。打ち切ったのが if で条件分けしてるところ、loc...s に文字入れてくのが else で除外してるところです。</p>
            <p>先に else の方を解説しましょう。''.join([loc...s, letter]) というのは loc...s と letter を、'' (空文字)を間に入れてつなげた文字列という意味です。つまりただ単に loc...s の後ろに letter をくっつけてるだけ。</p>
            <p>逆に if で分けられた方は loc...s が出来上がってるはずですから、s_analyze を発動、motion に返り値を格納します。駒を動かすときは list, 勝敗がついたときは int がリターンされますから、それによって場合分けしています。</p>
            <p>まずは駒を動かす場合です。実際に move メソッドで駒を動かし、記録を SUBRECADDRESS にとります。ここで、move におけるパラメーター変換の結果引数で要請されたターン、プレーヤーにたどり着いていれば、リターン作業に入ります。なお、isrecwrite が True の場合は MAINRECADDRESS に記録を転記しなければいけませんから、SUBRECADDRESS の内容をすべて MAINRECADDRESS へ書き込みます。そしてどちらの場合もリターンするのは local_board です。</p>
            <p>一方決着がついていれば駒を動かすことも記録をとることもしません。isrecwrite で転記が必要と判断されたら転記します。そして</p>
            <p class="stress">motion をリターン</p>
            <p>します。つまり返り値は勝ったプレーヤー番号、型は int です。お間違えなきよう。</p>
            <p>for 文を抜けた後にもう一度同じことをやります。リターンまで同じです。これをやらないと、最後の文が認識されない恐れがあります。嘘だと思うなら外して試してみな。</p>
            <p>ここまででリターンされなかったら引数で要求されたところまで盤面の動きを再現できなかったことを意味しますから self を返します。そうです。self を返してるんです。False ではありません。いや、False でもいいのかもしれませんが、私がコーディングした時 False でバグった経緯がありますので self をリターンしているんです。これで False がいやになったでしょう。</p>
        </section>

        <section id="s9-3">
            <h2>9-3　戻る機能</h2>
            <p>これでようやく「ひとつ戻る」の機能を実装できますね。<a href="../stage7/index.html#s7-4">7-4</a> で実装した部分、playmode で特殊イベントを扱ったところです。"X" や "H" の場合が書かれていますが、ここに "Z" の場合を追加します。</p>
            <p>まず相手に確認をとります。本来こういうボードゲームでは待ったはなしなので、ここは外さないでください。もし了承しなければ当然 continue して同じプレーヤーにもう一度操作を考え直してもらいます。相手から了承 "y" が得られれば、new_board にひとつ前の自分のターンで駒を動かす直前の状態を代入します。ここまでの棋譜をもう一度はじめからたどって前の状態にするんです。</p>
            <p>もしこれが main_board と同じであれば、tracefile は定義したクラスでいう self をリターンしたことになりますから失敗です。そのほかの場合は成功していますから、new_board に乗り換え、要は main_board へ new_board を代入します。そして BOARDprint を忘れずに。プレーヤーとしてはこれがないと「あれ、本当に戻ったのかな」と不安になってしまいます。</p>
            <p>成功にせよ失敗にせよ、次の操作も同じ人が行いますので continue してループ先頭へ行ってください。</p>
        </section>

        <section id="s9-4">
            <h2>9-4　読込モード</h2>
            <p>次は readmode.py へ行ってもらいます。sys, config, board をインポートします。もちろん config.py の中身は config. を付けなくてもいいようにしてください。記述するのは readmode 関数の中です。</p>
            <p>まずは読み取りモードを使うユーザーに心の準備をする時間をあげます。それが "ENTER TO START" の部分。これあったほうがいいですよ。main_board を初期化宣言したら while ループに入ります。</p>
            <p>ループの最初では「第何ターンのどちらの番か」を明記してあげます。また new_board には手番が終わった後の状況を tracefile を使って代入します。ご注意いただきたいのは、あくまで「手番が終わった後の盤面」を代入する点です。白が手番を終えたところまで tracefile で遡りたければ、引数は main_board.turn, BLACK ですし、黒が終えたところまで遡りたければ引数は main_board.turn + 1, WHITE です。しっかり確認してください。</p>
            <p>プレーヤーまで表示し終わったら new_board の型によって場合分けします。bool 型なら False 一択ですから、この時点で打ち切りです。必ず「もう続けられません」とユーザーに宣告してください。「おいおい、なんで勝手に終わってんだよ」とならないように。まあ、tracefile が bool を返すことは一応ないんですが、念には念を入れていいじゃないですか。new_board が int 型なら勝敗がついています。"1-0", "0-1" などの形でユーザーに勝敗を見せましょう。それ以外では駒を動かしている場合ですから、new_board を main_board に突っ込んでください。そして BOARDprint もお忘れなく。</p>
            <p>ユーザーがトイレに行きたくなったとかいろんな理由をつけて途中退室することも考えられますので、終了コード "X" を用意してあげます。</p>
            <p>関数を脱したところに if __name__ を書いて readmode だけをデバッグしたい場合に備えておきましょう。</p>
        </section>

        <section id="s9-5">
            <h2>9-5　全体統括</h2>
            <p>最後の仕上げです。main.py に入ります。いかにもメインの機能ですね。ここでは「対戦モードか読取モードか」を選ぶことしかしません。したがって playmode と readmode しかインポートしません。プレーヤーが対戦か読取か、どちらかの選択肢を選ぶまでずっと「どっちがいいですか」と聞くだけです。ちゃんと答えてくれたらお望みの機能を使わせてあげる。使い終わったら break して終わり。簡単でしょ。</p>
            <p>これで私のチェスのコードは完装できました。お疲れ様でした。今日はお祝いにケーキ買って帰ってください。「体脂肪が」とか気にしないで。人間適度なご褒美は必要ですよ。ほら、あんた頭の糖分たりてないでしょ。</p>
            <p>もし「おいおい、てめーのコードバグってんじゃねーか」という場合は、このページのフッター(一番下のところ)にリンクが貼ってありますのでそちらにお問い合わせいただければと思います。この解説に不備や不明な点がある場合でも結構です。本当に気軽に連絡くださって結構ですよ。いや、「ケーキ奢れ」はダメですけど。</p>
            <p>我々はチェスのゲームを作るためにいろんなことを学びました。2 次元配列の扱い、オブジェクト指向、文字列操作、正規表現、ファイルの読み書きなどなど。「プログラミング初めてだった」なんて方もいるかもしれません。いや、ここまで読み切ってる人のなかにいるわけないか、そんな天才。とにかく苦労してこのコードを書き上げた皆さんは、書く前とは別人になっているはずです。大変だったでしょう。私ですか。大変でしたよ、この解説書くの。冗談ですって、チェスのコーディング大変でしたって。いや、解説も大変でしたけど。でもコーディングするの面白かったじゃないですか。ね、面白かったでしょ。面白かったよね。ね。いや、このご時世にパワハラなんてしませんよ。しませんって。してねーだろ、おい。</p>
        </section>
    </main>

    <footer>
        <ul>
            <li>LAST EDITED: 2020/4/26</li>
            <li>
                <a href="https://github.com/Saito-Saito-Saito" target="_blank">このページの作成者のGitHub</a>
            </li>
            <li>
                <a href="https://twitter.com/zsops_n" target="_blank">このページの作成者のTwitter</a>
            </li>
            <li>
                <a href="#">トップに戻る</a>
            </li>
        </ul>
    </footer>
</body>
</html>