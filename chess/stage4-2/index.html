<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>これであなたもチェスが作れる 4-2</title>
    <link rel="stylesheet" href="../stylesheet.css">
</head>
<body>
    <header>
        <div id="title">
            <h1>これであなたも</h1>
            <h1>チェスが作れる</h1>
        </div>
        <ul>
            <li><a href="../index.html">Stage 0&1</a></li>
            <li><a href="../stage2/index.html">Stage 2</a></li>
            <li><a href="../stage3/index.html">Stage 3</a></li>
            <li><a href="../stage4-1/index.html">Stage 4-1</a></li>
            <li><a href="#">Stage 4-2</a></li>
            <li><a href="../stage5/index.html">Stage 5</a></li>
            <li><a href="../stage6/index.html">Stage 6</a></li>
            <li><a href="../stage7/index.html">Stage 7</a></li>
            <li><a href="../stage8/index.html">Stage 8</a></li>
            <li><a href="../stage9/index.html">Stage 9</a></li>
            <li><a href="https://github.com/Saito-Saito-Saito/chess" target="_blank">Code</a></li>
        </ul>
    </header>

    <div class="acd-menu">
        <input type="checkbox" id="acd-check">
        <label for="acd-check" class="acd-label">MENU</label>
        <ul class="acd-content">
            <li><a href="../index.html">Stage 0&1</a></li>
            <li><a href="../stage2/index.html">Stage 2</a></li>
            <li><a href="../stage3/index.html">Stage 3</a></li>
            <li><a href="../stage4-1/index.html">Stage 4-1</a></li>
            <li><a href="#">Stage 4-2</a></li>
            <li><a href="../stage5/index.html">Stage 5</a></li>
            <li><a href="../stage6/index.html">Stage 6</a></li>
            <li><a href="../stage7/index.html">Stage 7</a></li>
            <li><a href="../stage8/index.html">Stage 8</a></li>
            <li><a href="../stage9/index.html">Stage 9</a></li>
            <li><a href="https://github.com/Saito-Saito-Saito/chess" target="_blank">Code</a></li>
        </ul>
    </div>

    <main>
        <section id="s4-2">
            <h1>Stage 4-2　駒をうごかす〜移動編〜</h1>
            <p>前回ようやく駒の動きを判定する機能ができたので、今度は実際に駒を動かしてしまいましょう。駒をうごかすと言っても、ご存知の通りチェスのやつめはアンパッサンだのキャスリングだのプログラマー泣かせのルールをたくさんつけてきているので、「プレーヤーの駒をただ動かせばいいんだろ」という安直な考えはよしてください。まあ難易度自体は大したことありませんが。</p>
        </section>

        <section class="index">
            <h2>目次</h2>
            <p>
                <ul>
                    <li><a href="#s4-2-1">4-2-1　不可能な動きの除外</a></li>
                    <li><a href="#s4-2-2">4-2-2　キャスリング</a></li>
                    <li><a href="#s4-2-3">4-2-3　アンパッサン</a></li>
                    <li><a href="#s4-2-4">4-2-4　プロモーション</a></li>
                    <li><a href="#s4-2-5">4-2-5　自分の駒をうごかす</a></li>
                    <li><a href="#s4-2-6">4-2-6　パラメーター操作</a></li>
                </ul>
            </p>
        </section>

        <section id="s4-2-1">
            <h2>4-2-1　不可能な動きの除外</h2>
            <p>駒を実際に動かすのは Board クラスの move メソッドです。引数は motionjudge とまったく同じで移動元の座標、移動先の座標、プロモーションする駒番号です。promotion はデフォルトでは何にも成り上がらない EMPTY となっています。</p>
            <p>まずは入力した動きができるかを確かめます。万が一変な動きをされたら盤面がグッチャグチャになりますから、クラスの秩序を保つためになんとしてもやっておかなければなりません。</p>
            <p>具体的には move メソッドの一番上の if にある通り、move でもらった引数をそのまま motionjudge に通します。この値が False, つまり「移動不可能」であれば move も「実行不可能」False を返すという仕組みです。</p>
            <p>逆に、この関門を突破した移動は可能ですから、なんのためらいもなく駒を動かせます。</p>
            <p>また「動かしているのが自分の駒か」も確認します。これが違っていたら当然 False です。</p>
        </section>

        <section id="s4-2-2">
            <h2>4-2-2　キャスリング</h2>
            <p>ここからは「ただ自分の駒をそのまま動かすだけじゃいけない動き」を扱って行きます。代表格がキャスリングですね。キングだけじゃなくてルークも移動しなければいけませんから。</p>
            <p>まず引数から「これはキャスリングしようとしているな」と判別できなければなりません。<a href="../stage4-1/index.html#s4-1-2">Stage 4-1-2</a> でも確認した通り、キャスリングはキングの動きとして扱いますから、まずは「動かそうとしている駒がキングだ」ということを見極めます。そのために piece 変数を定義しています。player については不要です。実際に駒を動かすのは self.player でないと困ります。「じゃあなんで motionjudge のときは self.player を使わなかったか」って？そんなに知りたいなら motionjudge のキャスリングでどうやって「相手にチェックされているか」を調べたか思い出してください。忘れた？しゃーねーな、<a href="../stage4-1/index.html#s4-1-7">ここだよここ</a>。</p>
            <p>さて、直下の if 文によって piece がキングでヨコに 2 マス以上の移動をしていることが分かったとしましょう。間違いなくキャスリングです。さてキャスリングはすべて同じ rank 内で行われます。その番号は白と黒で異なりますので、場合分けが少なく済むように rank という変数を用意しておきます。白黒それぞれ第 1, 第 8 rank です。</p>
            <p>今度は file の変化からクイーンサイドとキングサイドで場合分けします。移動先が c の file であればクイーンサイド、g の file であればキングサイドです。キングはあとで他の場合と一緒に動かしますから、ここではルークを移動させます。キャスリングが終われば移動元は何もないので、ルークのあった場所はしっかり EMPTY にしておきましょう。これ忘れると「あれれ？ルークが増えてるぞ？」なんて奇怪なことになりかねません。</p>
        </section>

        <section id="s4-2-3">
            <h2>4-2-3　アンパッサン</h2>
            <p>アンパッサンも例外処理が必要です。というのも、取る相手の駒が移動先ではないところにありますから、移動先と移動元をいじっただけでは対処できません。相手の駒を取るコーディングが要ります。</p>
            <p>実際にやることは簡単です。まず入力された移動がアンパッサンをやろうとしていることを判別します。</p>
            <p>
                <ul>
                    <li>ポーンが</li>
                    <li>file を変えて</li>
                    <li>EMPTY のマスに移動している</li>
                </ul>
            </p>
            <p>の場合ですね。</p>
            <p>相手のポーンの座標が self.ep_target に格納されていますから、board[ep_target[FILE]][ep_target[RANK]] = EMPTY でそのポーンを取ることができます。</p>
        </section>

        <section id="s4-2-4">
            <h2>4-2-4　プロモーション</h2>
            <p>プロモーションも例外処理必要ですよ。動かす駒をただ動かすだけじゃ、駒の種類は変わりませんから。このあとしっかり駒を動かすので、ここでは駒の種類だけを変えます。</p>
            <p>ここで例外処理が必要な場合を判断するには少し注意が必要です。ただただ「promotion が EMPTY じゃない」ってだけだと、例えば piece がクイーンで promotion がナイトであったとしても、motionjudge 自体は True を返しますけれども、当然ルールとしてはアウトですよね。ポーンならいいということでもなく、例えば第 4 rank とか盤面のど真ん中でプロモーションされたら無法地帯になってしまいます。ですからここで例外処理を発動する条件を</p>
            <p>
                <ul>
                    <li>piece == PAWN</li>
                    <li>toRANK == 8 - 1 or 1 - 1</li>
                </ul>
            </p>
            <p>としておきましょう。この場合、まともにプロモーションしないとメソッド冒頭の motionjudge の時点で跳ね返されますから、無駄な確認が不要になります。</p>
            <p>今度は実際に駒の種類を変えます。まったく難しいことはありません。board[frFILE][frRANK] = self.player * promotion でおしまいです。ほら、簡単でしょ？</p>
            <p>ここまでくればもう例外処理はいらないでしょう。次はようやっと自分の駒を動かします。</p>
        </section>

        <section id="s4-2-5">
            <h2>4-2-5　自分の駒をうごかす</h2>
            <p>さて、ここから先はすべての動きについて適用します。[frFILE][frRANK] にある駒を [toFILE][toRANK] に移動させます。この際、移動先の処理は単純に</p>
            <pre>
                <code>
board[toFILE][toRANK] = board[frFILE][frRANK]
                </code>
            </pre>
            <p>とすればいいのですが、これだけでは移動したことになりません。だって移動元に駒残ってんだもん。ですから必ず、</p>
            <p class="stress">移動元を EMPTY に</p>
            <p>することを忘れないでください。</p>
            <p>これにて駒を動かす部分のコーディングは終了です。</p>
        </section>

        <section id="s4-2-6">
            <h2>4-2-6　パラメーター操作</h2>
            <p>「駒動かしたから終わりだー!!」と思ってはいけません。皆さんにはまだ大事な作業が残っています。今までさんざんお世話になってきたパラメーターの皆さんを放置しないでください。どういうことかって？ほら、ep_target とか castl_k とか、駒動かしたら確認しなきゃいけないってこのまえ言ったでしょ。順に見ていきましょうか。</p>
            <p>まずはアンパッサンにむけて ep_target を調整していきます。<a href="../stage4-1/index.html#s4-1-2">Stage 4-1-2</a> で確認した通り、「ポーンが 2 マス動いたら移動先の座標、それ以外は OVERSIZE」でしたね。ですから、toRANK と frRANK の差で分類して値を変えていきます。</p>
            <p>次はキャスリングです。キングサイドとクイーンサイドをまとめていっぺんにとはいかないので、それぞれ場合分けしてあげましょう。リストからプレーヤーを抜く条件は</p>
            <p>
                <ul>
                    <li>キングを動かした</li>
                    <li>そのサイドのルークを動かした</li>
                </ul>
            </p>
            <p>のいずれかになります。当然この中にはキャスリングも含まれますよ。キングの動きですから。</p>
            <p>今度はターンを増やします。とは言っても白→黒で 1 ターンですから、黒の時だけ値をいじりましょう。</p>
            <p>最後にプレーヤーを替えます。WHITE は +1, BLACK は -1 で定義していますから、交代するときはどちらも -1 をかけてあげてください。</p>
            <p>さあ、これですべてのパラメーター処理が終わりました。実行不可能を表す False に対する形で「実行成功」True をリターンしてあげてください。以上で駒をうごかす機能は実装終了となります。お疲れ様でした。</p>
            <p>一応ここでしっかり機能するかテストしておくといいと思います。frFILE, frRANK, ... と一つ一つ手入力して「本当にしっかり動いているかな」と検証しておきましょう。正しい動き方はもちろん、間違った動き方を入力した際にちゃんと「動けない」とアラートなりなんなりを出すかも確認してください。ルールを知らない人がゲームしても問題ないようにね。</p>
        </section>

        <section>
            <h2>次回予告</h2>
            <p>とうとうここまでで「チェスのゲームに絶対必要な機能」が揃いました。次からはゲームの装飾になります。ただただ駒をうごかすだけじゃ、なんだか味気ないでしょ？まずは勝敗の判定をします。そのためにチェックを判別できるようにしないといけないのですが、まあこれは一度やってるからね。</p>
            <p><a href="../stage5/index.html">次回　Stage 5　勝敗を判定する</a></p>
        </section>
    </main>

    <footer>
        <ul>
            <li>LAST EDITED: 2020/5/6</li>
            <li><a href="../../index.html">解説一覧</a></li>
            <li>
                <a href="https://github.com/Saito-Saito-Saito" target="_blank">このページの作成者のGitHub</a>
            </li>
            <li>
                <a href="https://twitter.com/zsops_n" target="_blank">このページの作成者のTwitter</a>
            </li>
            <li>
                <a href="#">トップに戻る</a>
            </li>
        </ul>
    </footer>
</body>
</html>